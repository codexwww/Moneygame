<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Money Game</title>
<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #0f172a;
    color: white;
    display: flex;
}

.sidebar {
    width: 220px;
    background: #020617;
    height: 100vh;
    padding: 20px;
}

.menu-item {
    margin: 12px 0;
    cursor: pointer;
    color: #cbd5f5;
    font-weight: bold;
}
.menu-item:hover { color: #22c55e; }

.content {
    flex: 1;
    padding: 30px;
}

.card {
    background: #1e293b;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 15px;
    box-shadow: 0 0 10px rgba(0,255,0,0.2);
    transition: all 0.3s ease;
}

.card.up { box-shadow: 0 0 10px rgba(34,197,94,0.5); }
.card.down { box-shadow: 0 0 10px rgba(239,68,68,0.5); }

.action {
    display: flex;
    justify-content: space-between;
    cursor: pointer;
    padding: 10px;
}

.up { color: #22c55e; }
.down { color: #ef4444; }

canvas {
    background: #020617;
    border-radius: 10px;
    margin-top: 15px;
}

input {
    padding: 8px;
    width: 140px;
    margin-right: 10px;
}

button {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    background: #22c55e;
    color: black;
    margin-right: 5px;
    transition: all 0.2s ease;
}
button:hover { background: #16a34a; }

h1 { margin-top: 0; }

/* New styles for dashboard layout */
.row { display:flex; gap:15px; align-items:flex-start; }
.col { flex:1; }
.small { width:360px; }
.card-clickable { cursor:pointer; }
.kv { display:flex; align-items:center; justify-content:space-between; }
.meta { color:#cbd5f5; font-size:0.9em; }
.badge { background:#111827; padding:6px 10px; border-radius:8px; color:#cbd5f5; }
.quick-buttons button { padding:6px 10px; font-size:0.9em; margin-right:6px; }
.helper { color:#9ca3af; font-size:0.9em; margin-top:8px; }

/* Casino */
.casino-grid { display:flex; gap:12px; align-items:flex-start; }
.casino-col { flex:1; }
.small-input { width:100px; padding:6px; }
.center { text-align:center; }
</style>
</head>
<body>

<div class="sidebar">
    <h2>üí∞ Money Game</h2>
    <div class="menu-item" onclick="dashboard()">üè† Accueil</div>
    <div class="menu-item" onclick="investPage()">üìà Investir</div>
    <div class="menu-item" onclick="openCasino()">üé≤ Casino</div>
    <div class="menu-item" onclick="helpPage()">‚ùì Help</div>
</div>

<div class="content" id="content"></div>

<script>
// ===== VARIABLES GLOBALES =====
let currentPage = "dashboard"; // dashboard / invest / action_x / help / casino
let currentActionId = null;

let argent = localStorage.getItem("argent")
    ? parseFloat(localStorage.getItem("argent"))
    : 10000;

let portfolio = localStorage.getItem("portfolio")
    ? JSON.parse(localStorage.getItem("portfolio"))
    : {0:0,1:0,2:0};

// action definitions with names / initial prices; timers set via nextTimer
const actions = [
    loadAction(0,"Moni Invest (principal)",100),
    loadAction(1,"Crypto (secondaire)",100),
    loadAction(2,"Water Co (autre)",500)
];

// histories for charts (extended retention)
let argentHistory = localStorage.getItem("argentHistory")
    ? JSON.parse(localStorage.getItem("argentHistory"))
    : [argent];

let rankHistory = localStorage.getItem("rankHistory")
    ? JSON.parse(localStorage.getItem("rankHistory"))
    : [getRankNumeric(argent)];

// news history & active effects
let newsHistory = localStorage.getItem("newsHistory")
    ? JSON.parse(localStorage.getItem("newsHistory"))
    : [];
let activeNewsEffects = {}; // {actionId: {mult:1.2, remainingSecs:20, text:"..."} }

// BOTs: 5 robots starting at 3000
let bots = localStorage.getItem("bots")
    ? JSON.parse(localStorage.getItem("bots"))
    : createInitialBots();

function createInitialBots(){
    const list = [];
    for(let i=1;i<=5;i++){
        list.push({
            id: "Bot"+i,
            cash: 3000,
            portfolio: {0:0,1:0,2:0}
        });
    }
    localStorage.setItem("bots", JSON.stringify(list));
    return list;
}

// Build players list derived from bots + you
function updatePlayersList(){
    const players = [];
    players.push({name: "Vous", total: argent + totalPortfolioValue()});
    bots.forEach(b=>{
        const total = b.cash + botPortfolioValue(b);
        players.push({name: b.id, total: total});
    });
    localStorage.setItem("players", JSON.stringify(players));
    return players;
}

// save bots and players
function saveBotsAndPlayers(){
    localStorage.setItem("bots", JSON.stringify(bots));
    updatePlayersList();
}

// helper to calculate bot portfolio value
function botPortfolioValue(bot) {
    let v = 0;
    actions.forEach(a=> v += (bot.portfolio[a.id]||0)*a.prix);
    return v;
}

// loadAction / timer logic
function loadAction(id, nom, prix) {
    let saved = localStorage.getItem("action_"+id);
    if (saved) {
        let obj = JSON.parse(saved);
        // ensure name updated if code changed
        obj.nom = nom;
        return obj;
    }
    return { id, nom, prix, prev: prix, timer: nextTimer(id), history: [prix] };
}

// timers adapt√©s par action
function nextTimer(id) {
    if(id === 0) return 30;   // principal : 30s
    if(id === 1) return 60;   // secondaire : 60s
    if(id === 2) return 300;  // autre : 300s (5min)
    return Math.floor(Math.random() * 91) + 30; // fallback 30..120
}

// helper pour d√©tecter si l'utilisateur est en train d'√©crire (emp√™che le re-render)
function isUserTyping() {
    try {
        const ae = document.activeElement;
        if(!ae) return false;
        const tag = ae.tagName;
        if(tag === 'INPUT' || tag === 'TEXTAREA') return true;
        if(ae.isContentEditable) return true;
        return false;
    } catch(e) {
        return false;
    }
}

function save() {
    localStorage.setItem("argent", argent);
    localStorage.setItem("portfolio", JSON.stringify(portfolio));
    actions.forEach(a=>localStorage.setItem("action_"+a.id, JSON.stringify(a)));

    // extend retention to 10000 snapshots so we can show long timelines
    argentHistory.push(parseFloat(argent));
    if(argentHistory.length>10000) argentHistory.shift();
    localStorage.setItem("argentHistory", JSON.stringify(argentHistory));

    rankHistory.push(getRankNumeric(argent + totalPortfolioValue()));
    if(rankHistory.length>10000) rankHistory.shift();
    localStorage.setItem("rankHistory", JSON.stringify(rankHistory));

    localStorage.setItem("newsHistory", JSON.stringify(newsHistory));
    saveBotsAndPlayers();
}

// helper to calculate total portfolio value (user)
function totalPortfolioValue() {
    let v = 0;
    actions.forEach(a=> v += portfolio[a.id]*a.prix);
    return v;
}

// numeric rank for charting (higher is better)
function getRankNumeric(total) {
    if(total<10000) return 1;
    else if(total<20000) return 2;
    else if(total<50000) return 3;
    else return 4;
}

// ==== CALCUL DU RANG (texte) ====
function getRank() {
    let total = argent + totalPortfolioValue();
    if(total<10000) return "D√©butant";
    else if(total<20000) return "Amateur";
    else if(total<50000) return "Pro";
    else return "Expert";
}

// ==== DASHBOARD ====
function dashboard() {
    currentPage = "dashboard";
    updatePlayersList();
    let value = totalPortfolioValue();
    // latest news
    const latestNews = newsHistory.length? newsHistory[newsHistory.length-1].text : "Aucune news r√©cente.";

    let html = `<h1>Tableau de bord</h1>
        <div class="row">
            <div class="col small">
                <div class="card card-clickable" onclick="openMoney()"> 
                    <div class="kv">
                        <div>
                            <strong>üí∞ Argent disponible</strong><br>
                            <span class="meta">${argent.toFixed(2)} ‚Ç¨</span>
                        </div>
                        <div class="badge">${portfolioValueLabel()}</div>
                    </div>
                    <canvas id="moneyMiniChart" width="320" height="120"></canvas>
                    <div class="helper">Cliquez pour voir plus de d√©tails sur votre historique d'argent.</div>
                </div>

                <div class="card card-clickable" onclick="openStatus()">
                    <strong>üè∑Ô∏è Statut</strong><br>
                    <div style="margin-top:8px;">
                        <span style="font-size:1.1em; font-weight:bold;">${getRank()}</span>
                        <div class="helper">Cliquez pour voir les paliers de statut et seuils associ√©s.</div>
                    </div>
                </div>
            </div>

            <div class="col">
                <div class="card card-clickable" onclick="openRank()">
                    <strong>üèÖ Rang (global)</strong><br>
                    <div style="margin-top:8px;">
                        <span style="font-size:1.2em; font-weight:bold;">#1 (solo)</span>
                        <div class="helper">Cliquez pour afficher le classement des joueurs et l'√©volution du rang.</div>
                    </div>
                    <canvas id="rankMiniChart" width="600" height="120"></canvas>
                </div>

                <div class="card">
                    <strong>üíº Valeur du portefeuille</strong><br>
                    <span class="meta">${value.toFixed(2)} ‚Ç¨</span>
                    <div style="margin-top:10px;">
                        <strong>D√©tails :</strong><br>`;
    actions.forEach(a=>{
        html+=`${a.nom} : ${portfolio[a.id].toFixed(4)} parts (valeur : ${(portfolio[a.id]*a.prix).toFixed(2)} ‚Ç¨)<br>`;
    });
    html+=`</div></div>
            </div>
        </div>

        <div class="row">
            <div class="col small">
                <div class="card">
                    <strong>üì∞ News (derni√®re)</strong><br>
                    <div style="margin-top:8px;">${latestNews}</div>
                    <div class="helper">Une news appara√Æt toutes les 5 minutes et peut influencer les actions.</div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <strong>Classement rapide</strong><br>
                    <div style="margin-top:8px;">
                        <ol>`;
    const players = updatePlayersList();
    // show top 5
    players.slice(0,5).forEach(p=>{
        html+=`<li>${p.name} ‚Äî ${p.total.toFixed(2)} ‚Ç¨</li>`;
    });
    html+=`</ol>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.getElementById("content").innerHTML = html;

    // draw mini charts (more points, uses entire history window)
    drawMiniMoneyChart();
    drawMiniRankChart();
}

function portfolioValueLabel() {
    let val = totalPortfolioValue();
    if(val<1000) return `${val.toFixed(0)} ‚Ç¨ portefeuille`;
    return `${val.toFixed(2)} ‚Ç¨ portefeuille`;
}

// ==== INVEST PAGE ====
function investPage() {
    currentPage = "invest";
    let html = `<h1>Investir</h1>`;
    actions.forEach(a=>{
        let diff = (((a.prix-a.prev)/a.prev)*100).toFixed(2);
        html += `<div class="card ${diff>=0?'up':'down'} action" onclick="openAction(${a.id})">
            <div>
                <strong>${a.nom}</strong><br>
                <span class="${diff>=0?'up':'down'}">${diff>=0?'‚ñ≤':'‚ñº'} ${diff} %</span>
            </div>
            <div>‚è±Ô∏è ${a.timer}s</div>
        </div>`;
    });
    document.getElementById("content").innerHTML = html;
}

// ==== ACTION DETAIL ====
function openAction(id) {
    currentPage = "action_"+id;
    currentActionId = id;
    let a = actions[id];
    let holdingsValue = (portfolio[id]*a.prix).toFixed(2);
    document.getElementById("content").innerHTML = `
        <h1>${a.nom}</h1>
        <canvas id="chart" width="700" height="250"></canvas>

        <div class="card">
            <button onclick="drawChart(${id},60)">60 pts</button>
            <button onclick="drawChart(${id},300)">300 pts</button>
            <button onclick="drawChart(${id},1000)">1000 pts</button>
        </div>

        <div class="card">
            üí≤ Prix : ${a.prix} ‚Ç¨<br>
            üì¶ Parts : ${portfolio[id].toFixed(4)} (valeur actuelle : ${holdingsValue} ‚Ç¨)
        </div>

        <div class="card">
            <strong>Acheter</strong><br>
            <input id="buyAmount" type="number" placeholder="Montant ‚Ç¨">
            <button onclick="buy(${id})">Investir</button>
            <div class="helper">Entrez un montant en euros √† convertir au prix courant.</div>
        </div>

        <div class="card">
            <strong>Vendre</strong><br>
            <div>
                <label><input type="radio" name="sellMode" value="euro" checked> Vendre en ‚Ç¨</label>
                <label style="margin-left:12px;"><input type="radio" name="sellMode" value="parts"> Vendre en parts</label>
            </div>
            <input id="sellAmount" type="number" placeholder="Montant ‚Ç¨ ou parts selon le mode">
            <div class="quick-buttons" style="margin-top:8px;">
                <button onclick="setSellPercent(${id},25)">Vendre 25%</button>
                <button onclick="setSellPercent(${id},50)">Vendre 50%</button>
                <button onclick="setSellPercent(${id},100)">Vendre tout</button>
            </div>
            <br>
            <button onclick="sell(${id})">Ex√©cuter vente</button>
            <button onclick="sellAll(${id})" style="background:#ef4444;color:white;">Vendre tout</button>
            <div class="helper">Vous pouvez vendre par montant en ‚Ç¨ (au prix courant) ou par parts. Un clic sur "Vendre tout" vend la totalit√© de vos parts pour le montant courant.</div>
        </div>

        <div class="card">üèÖ Rang : ${getRank()}</div>

        <button onclick="investPage()">‚¨Ö Retour</button>
    `;
    drawChart(id,60);
}

// ==== setSellPercent helper ====
function setSellPercent(id, percent) {
    let a = actions[id];
    let partsOwned = portfolio[id];
    let mode = document.querySelector('input[name="sellMode"]:checked').value;
    if(mode === 'parts') {
        document.getElementById('sellAmount').value = (partsOwned * (percent/100)).toFixed(6);
    } else {
        // euros value of that percent
        let euros = partsOwned * a.prix * (percent/100);
        document.getElementById('sellAmount').value = euros.toFixed(2);
    }
}

// ==== COURBE ====
function drawChart(id, points) {
    let a = actions[id];
    let data = a.history.slice(-points);
    if(data.length<2) data = a.history; // show full if not enough
    let c = document.getElementById("chart");
    if(!c) return;
    let ctx = c.getContext("2d");
    ctx.clearRect(0,0,c.width,c.height);

    let max = Math.max(...data);
    let min = Math.min(...data);

    ctx.beginPath();
    ctx.strokeStyle = "#22c55e";
    ctx.lineWidth = 2;

    data.forEach((v,i)=>{
        let x = i*(c.width/data.length);
        let y = c.height - ((v-min)/(max-min||1))* (c.height-10) - 5;
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
    });
    ctx.stroke();
}

// mini money chart on dashboard (large window so evolution visible)
function drawMiniMoneyChart() {
    let c = document.getElementById("moneyMiniChart");
    if(!c) return;
    let ctx = c.getContext("2d");
    // show as much as available (up to 1000 points for performance)
    let data = argentHistory.slice(-1000);
    if(data.length<2) data = argentHistory;
    ctx.clearRect(0,0,c.width,c.height);
    let max = Math.max(...data);
    let min = Math.min(...data);
    ctx.beginPath();
    ctx.strokeStyle = "#60a5fa";
    ctx.lineWidth = 1.5;
    data.forEach((v,i)=>{
        let x = i*(c.width/data.length);
        let y = c.height - ((v-min)/(max-min||1))* (c.height-10) - 5;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
}

function drawMiniRankChart() {
    let c = document.getElementById("rankMiniChart");
    if(!c) return;
    let ctx = c.getContext("2d");
    let data = rankHistory.slice(-500);
    if(data.length<2) data = rankHistory;
    ctx.clearRect(0,0,c.width,c.height);
    let max = Math.max(...data);
    let min = Math.min(...data);
    ctx.beginPath();
    ctx.strokeStyle = "#fbbf24";
    ctx.lineWidth = 1.5;
    data.forEach((v,i)=>{
        let x = i*(c.width/data.length);
        let y = c.height - ((v-min)/(max-min||1))* (c.height-10) - 5;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
}

// ==== BUY / SELL ====
function buy(id) {
    let elem = document.getElementById("buyAmount");
    if(!elem) return;
    let amount = parseFloat(elem.value);
    let a = actions[id];
    if(!amount || amount<=0) return alert("Montant invalide");
    if(amount>argent) return alert("Montant sup√©rieur √† l'argent disponible");
    portfolio[id]+=amount/a.prix;
    argent-=amount;
    save();
    openAction(id);
}

// sell supports two modes: euros or parts
function sell(id) {
    let raw = parseFloat(document.getElementById("sellAmount").value);
    let a = actions[id];
    if(!raw || raw<=0) return alert("Montant invalide");
    let mode = document.querySelector('input[name="sellMode"]:checked').value;
    if(mode === 'parts') {
        if(raw>portfolio[id]) return alert("Vous n'avez pas autant de parts");
        portfolio[id]-=raw;
        let euros = raw * a.prix;
        argent+=euros;
    } else {
        // euro mode
        let parts = raw / a.prix;
        if(parts>portfolio[id]) return alert("Vous n'avez pas suffisamment de parts pour ce montant");
        portfolio[id]-=parts;
        argent+=raw;
    }
    save();
    openAction(id);
}

// sell all holdings of an action
function sellAll(id) {
    let a = actions[id];
    let parts = portfolio[id];
    if(parts<=0) return alert("Vous n'avez pas de parts √† vendre");
    let euros = parts * a.prix;
    portfolio[id]=0;
    argent+=euros;
    save();
    openAction(id);
}

// ==== HELP PAGE ====
function helpPage() {
    currentPage = "help";
    currentActionId = null;
    document.getElementById("content").innerHTML = `
        <h1>üìò Aide / Instructions</h1>
        <div class="card">
            <h3>Argent vs Portefeuille</h3>
            <p>
                üí∞ Argent : votre cash disponible pour investir.<br>
                üíº Portefeuille : parts d'actions poss√©d√©es. Valeur = parts √ó prix actuel.<br>
                Total compte = Argent + Portefeuille
            </p>
        </div>

        <div class="card">
            <h3>Investir / Vendre</h3>
            <p>
                1Ô∏è‚É£ Cliquez sur "Investir" pour voir les actions.<br>
                2Ô∏è‚É£ Cliquez sur une action pour voir sa courbe.<br>
                3Ô∏è‚É£ Entrez le montant √† investir ou r√©cup√©rer, puis cliquez sur le bouton.<br>
                ‚ö†Ô∏è Vous ne pouvez pas investir plus que votre argent disponible, ni r√©cup√©rer plus que vos parts.
            </p>
        </div>

        <div class="card">
            <h3>Courbes</h3>
            <p>
                üìà Les courbes montrent l'√©volution du prix. Utilisez les boutons pour changer la fen√™tre d'affichage.
            </p>
        </div>

        <div class="card">
            <h3>Rang</h3>
            <p>
                üèÖ Votre rang d√©pend de Argent + Portefeuille.<br>
                - D√©butant : < 10‚ÄØ000 ‚Ç¨<br>
                - Amateur : 10‚ÄØ000 ‚Äì 20‚ÄØ000 ‚Ç¨<br>
                - Pro : 20‚ÄØ000 ‚Äì 50‚ÄØ000 ‚Ç¨<br>
                - Expert : > 50‚ÄØ000 ‚Ç¨
            </p>
        </div>

        <div class="card">
            <h3>Astuce</h3>
            <p>
                Commencez petit, suivez les courbes, et n‚Äôinvestissez pas tout d‚Äôun coup !
            </p>
        </div>
    `;
}

// ==== DETAILED VIEWS FOR CARDS ====
// openMoney: affiche l'historique d√©taill√© de l'argent (fen√™tre large)
function openMoney() {
    currentPage = "money";
    document.getElementById("content").innerHTML = `
        <h1>Historique de l'argent</h1>
        <div class="card">
            <strong>Argent disponible : ${argent.toFixed(2)} ‚Ç¨</strong>
            <canvas id="moneyChart" width="1000" height="300"></canvas>
            <div class="helper">Historique enregistr√© (dernier ${argentHistory.length} snapshots).</div>
        </div>
        <button onclick="dashboard()">‚¨Ö Retour</button>
    `;
    setTimeout(()=> {
        let c = document.getElementById("moneyChart");
        if(!c) return;
        let ctx = c.getContext("2d");
        // use up to 5000 points to draw long timeline
        let data = argentHistory.slice(-5000);
        if(data.length<2) data = argentHistory;
        ctx.clearRect(0,0,c.width,c.height);
        let max = Math.max(...data);
        let min = Math.min(...data);
        ctx.beginPath();
        ctx.strokeStyle = "#60a5fa";
        ctx.lineWidth = 2;
        data.forEach((v,i)=>{
            let x = i*(c.width/data.length);
            let y = c.height - ((v-min)/(max-min||1))* (c.height-10) - 5;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
    },50);
}

// openRank: affiche classement des joueurs et evolution du rang
function openRank() {
    currentPage = "rank";
    let players = updatePlayersList().slice().sort((a,b)=>b.total - a.total);
    let html = `<h1>Classement des joueurs</h1>
        <div class="card">
            <strong>Classement</strong><br><ol>`;
    players.forEach(p=>{
        html+=`<li>${p.name} ‚Äî ${p.total.toFixed(2)} ‚Ç¨</li>`;
    });
    html+=`</ol>
            <canvas id="rankChart" width="900" height="200"></canvas>
            <div class="helper">Graphique d'√©volution du rang (√©chelle interne). Les bots sont simul√©s.</div>
        </div>
        <button onclick="dashboard()">‚¨Ö Retour</button>`;
    document.getElementById("content").innerHTML = html;

    setTimeout(()=> {
        let c = document.getElementById("rankChart");
        if(!c) return;
        let ctx = c.getContext("2d");
        let data = rankHistory.slice(-1000);
        if(data.length<2) data = rankHistory;
        ctx.clearRect(0,0,c.width,c.height);
        let max = Math.max(...data);
        let min = Math.min(...data);
        ctx.beginPath();
        ctx.strokeStyle = "#f59e0b";
        ctx.lineWidth = 2;
        data.forEach((v,i)=>{
            let x = i*(c.width/data.length);
            let y = c.height - ((v-min)/(max-min||1))* (c.height-10) - 5;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
    },50);
}

// openStatus: affiche paliers de statut
function openStatus() {
    currentPage = "status";
    document.getElementById("content").innerHTML = `
        <h1>Statuts et seuils</h1>
        <div class="card">
            <strong>Statuts disponibles</strong>
            <ul>
                <li>D√©butant : &lt; 10 000 ‚Ç¨</li>
                <li>Amateur : 10 000 ‚Ç¨ ‚Äì 20 000 ‚Ç¨</li>
                <li>Pro : 20 000 ‚Ç¨ ‚Äì 50 000 ‚Ç¨</li>
                <li>Expert : &gt; 50 000 ‚Ç¨</li>
            </ul>
            <div class="helper">Votre statut actuel : <strong>${getRank()}</strong></div>
        </div>
        <button onclick="dashboard()">‚¨Ö Retour</button>
    `;
}

// ==== NEWS GENERATOR =====
let newsTimer = localStorage.getItem("newsTimer") ? parseInt(localStorage.getItem("newsTimer")) : 300; // 5min
function generateNews(){
    // sample news items that influence actions
    const pool = [
        {text: "P√©nurie d'eau signal√©e : hausse probable des actions Water Co", target:2, mult:1.20},
        {text: "Nouvelle r√®glementation favorable aux banques : l√©g√®re hausse Moni Invest", target:0, mult:1.08},
        {text: "Crash crypto mineur : Crypto chute", target:1, mult:0.80},
        {text: "Rumeur d'innovation sur Water Co : action volatille", target:2, mult:1.15},
        {text: "Crypto adopte une nouvelle tech, volatilit√© accrue", target:1, mult:1.10}
    ];
    const pick = pool[Math.floor(Math.random()*pool.length)];
    const news = { time: Date.now(), text: pick.text, target: pick.target, mult: pick.mult, duration: 30 }; // effect lasts 30s
    newsHistory.push(news);
    if(newsHistory.length>200) newsHistory.shift();
    // activate effect
    activeNewsEffects[pick.target] = {mult: pick.mult, remainingSecs: news.duration, text: pick.text};
    localStorage.setItem("newsHistory", JSON.stringify(newsHistory));
    return news;
}

// ==== BOT SIMULATION ====
function simulateBots() {
    bots.forEach(bot=>{
        // small probability each second to act
        if(Math.random() < 0.02){ // ~ once every 50s per bot on average
            const actionId = Math.floor(Math.random()*actions.length);
            const a = actions[actionId];
            // choose buy or sell (50/50)
            if(Math.random()<0.5){
                // buy small amount (10..150)
                let amount = Math.round((Math.random()*140)+10);
                // ensure bot cash doesn't drop below 3000
                if(bot.cash - amount < 3000) {
                    amount = Math.max(0, Math.floor(bot.cash - 3000));
                }
                if(amount>0){
                    bot.portfolio[actionId] = (bot.portfolio[actionId]||0) + (amount / a.prix);
                    bot.cash -= amount;
                }
            } else {
                // sell small percent of holdings
                const parts = bot.portfolio[actionId] || 0;
                if(parts>0){
                    const pct = (Math.random()*0.6); // sell up to 60%
                    const sellParts = parts * pct;
                    bot.portfolio[actionId] = Math.max(0, parts - sellParts);
                    bot.cash += sellParts * a.prix;
                }
            }
        }
        // ensure bot total doesn't drop below 3000: top-up if market drop made them <3000
        const total = bot.cash + botPortfolioValue(bot);
        if(total < 3000){
            bot.cash += (3000 - total);
        }
    });
    saveBotsAndPlayers();
}

// ==== MARKET LOOP =====
// volatility map per action id
const volMap = {
    0: 0.02,  // Moni Invest stable ~2%
    1: 0.12,  // Crypto volatile ~12%
    2: 0.40   // Water Co very random ~40% (could be large)
};

setInterval(()=>{
    // news timer countdown
    newsTimer--;
    if(newsTimer<=0){
        generateNews();
        newsTimer = 300; // reset 5min
        localStorage.setItem("newsTimer", newsTimer);
    }
    // decrement active news effects
    Object.keys(activeNewsEffects).forEach(k=>{
        activeNewsEffects[k].remainingSecs--;
        if(activeNewsEffects[k].remainingSecs<=0) delete activeNewsEffects[k];
    });

    actions.forEach(a=>{
        a.timer--;
        if(a.timer<=0){
            a.prev = a.prix;
            // compute volatility influenced by news effects
            const baseVol = volMap[a.id] || 0.1;
            // if there's an active effect for this action, apply that multiplier with some randomness
            const effect = activeNewsEffects[a.id];
            let mult = 1;
            if(effect) mult = effect.mult;
            // different strategies per action:
            if(a.id === 0){
                // Moni Invest: small gaussian-ish change around baseVol
                const changeFactor = 1 + ((Math.random()*2-1) * baseVol) * (Math.random()*0.8 + 0.6);
                a.prix = Math.max(5, Math.round(a.prix * changeFactor * mult));
            } else if(a.id === 1){
                // Crypto: larger swings, keep around 100 mean (some pull to 100)
                let drift = 1 + ((100 - a.prix) / 10000); // slight pull
                const change = 1 + ((Math.random()*2-1) * baseVol);
                a.prix = Math.max(2, Math.round(a.prix * change * drift * mult));
            } else {
                // Water Co / other: very random, can change a lot
                const change = 1 + ((Math.random()*2-1) * baseVol);
                a.prix = Math.max(1, Math.round(a.prix * change * mult));
            }

            // keep history and cap
            a.history.push(a.prix);
            if(a.history.length>10000) a.history.shift();
            // reset timer per action
            a.timer = nextTimer(a.id);
            save();
        }
    });

    // simulate bots occasionally
    simulateBots();

    // update UI only if user not typing
    if(!isUserTyping()){
        if(currentPage === "invest") investPage();
        if(currentPage && currentPage.startsWith("action_")) openAction(currentActionId);
        if(currentPage === "dashboard") dashboard(); // refresh small data like timers
    }

    // periodic snapshot for charts
    argentHistory.push(parseFloat(argent));
    if(argentHistory.length>10000) argentHistory.shift();
    rankHistory.push( getRankNumeric(argent + totalPortfolioValue()) );
    if(rankHistory.length>10000) rankHistory.shift();
    localStorage.setItem("argentHistory", JSON.stringify(argentHistory));
    localStorage.setItem("rankHistory", JSON.stringify(rankHistory));
    localStorage.setItem("newsHistory", JSON.stringify(newsHistory));
    localStorage.setItem("bots", JSON.stringify(bots));
},1000);

// ==== START ====
updatePlayersList();
dashboard();

// ===== CASINO IMPLEMENTATION (Roulette + Blackjack) =====
function openCasino(){
    currentPage = "casino";
    document.getElementById("content").innerHTML = `
        <h1>üé≤ Casino</h1>
        <div class="casino-grid">
            <div class="casino-col card">
                <h3>Roulette</h3>
                <div>
                    <label>Mise (‚Ç¨): <input id="rouletteBet" class="small-input" type="number" value="10"></label>
                </div>
                <div style="margin-top:8px;">
                    <button onclick="playRoulette('red')">Parier Rouge</button>
                    <button onclick="playRoulette('black')">Parier Noir</button>
                    <button onclick="openRouletteNumberInput()">Parier N¬∞</button>
                </div>
                <div id="rouletteNumberInput" style="display:none;margin-top:8px;">
                    <label>N¬∞ (0-36): <input id="rouletteNumber" class="small-input" type="number" min="0" max="36"></label>
                    <button onclick="playRoulette('number')">Parier N¬∞</button>
                </div>
                <div id="rouletteResult" class="helper" style="margin-top:10px;"></div>
            </div>

            <div class="casino-col card">
                <h3>Blackjack</h3>
                <div>
                    <label>Mise (‚Ç¨): <input id="bjBet" class="small-input" type="number" value="20"></label>
                </div>
                <div style="margin-top:8px;">
                    <button onclick="startBlackjack()">D√©marrer</button>
                    <button onclick="hitBlackjack()" id="bjHit" style="display:none;">Hit</button>
                    <button onclick="standBlackjack()" id="bjStand" style="display:none;">Stand</button>
                </div>
                <div id="bjState" class="helper" style="margin-top:10px;"></div>
            </div>
        </div>
        <br>
        <button onclick="dashboard()">‚¨Ö Retour</button>
    `;
}

// Roulette helpers
function openRouletteNumberInput(){ document.getElementById('rouletteNumberInput').style.display='block'; }
function playRoulette(mode){
    let bet = parseFloat(document.getElementById("rouletteBet").value);
    if(!bet || bet<=0) return alert("Montant invalide");
    if(bet>argent) return alert("Pas assez d'argent");
    let number = Math.floor(Math.random()*37); // 0..36
    const redNumbers = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]); // approximate mapping
    let resultText = `La bille tombe sur ${number} (${ redNumbers.has(number) ? 'rouge' : (number===0? 'vert' : 'noir') }). `;
    let win = 0;
    if(mode === 'red' || mode === 'black'){
        if(number===0){
            win = 0;
        } else {
            const isRed = redNumbers.has(number);
            if((mode==='red' && isRed) || (mode==='black' && !isRed)) win = bet * 2;
        }
    } else if(mode === 'number'){
        const pick = parseInt(document.getElementById("rouletteNumber").value);
        if(isNaN(pick) || pick<0 || pick>36) return alert("Num√©ro invalide");
        if(pick === number) win = bet * 36;
    }
    if(win>0){
        argent += (win - bet);
        resultText += `Vous gagnez ${ (win - bet).toFixed(2) } ‚Ç¨ (retour total ${win.toFixed(2)} ‚Ç¨).`;
    } else {
        argent -= bet;
        resultText += `Vous perdez ${bet.toFixed(2)} ‚Ç¨.`;
    }
    save();
    // afficher le r√©sultat sur la page Casino sans rediriger
    const el = document.getElementById("rouletteResult");
    if(el) el.innerText = resultText;
    // rester sur la page casino; timers/UI seront rafra√Æchis par la boucle principale
}

// Simple Blackjack implementation
let bjGame = null;
function startBlackjack(){
    let bet = parseFloat(document.getElementById("bjBet").value);
    if(!bet || bet<=0) return alert("Montant invalide");
    if(bet>argent) return alert("Pas assez d'argent");
    // initialize deck (simplified)
    bjGame = {
        bet: bet,
        deck: createDeck(),
        player: [],
        dealer: [],
        finished: false
    };
    // deal
    bjGame.player.push(drawCard(bjGame.deck));
    bjGame.player.push(drawCard(bjGame.deck));
    bjGame.dealer.push(drawCard(bjGame.deck));
    bjGame.dealer.push(drawCard(bjGame.deck));
    document.getElementById("bjHit").style.display = 'inline-block';
    document.getElementById("bjStand").style.display = 'inline-block';
    updateBJState();
}
function createDeck(){
    const vals = [2,3,4,5,6,7,8,9,10,10,10,10,11]; // 10 x4 for JQK, 11 for A
    let deck = [];
    for(let i=0;i<4;i++){
        for(let v of vals) deck.push(v);
    }
    // shuffle
    for(let i=deck.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [deck[i],deck[j]] = [deck[j],deck[i]];
    }
    return deck;
}
function drawCard(deck){ if(deck.length===0) deck = createDeck(); return deck.pop(); }
function sumHand(hand){
    let sum = hand.reduce((s,v)=>s+v,0);
    // handle aces (11 -> 1 if bust)
    for(let i=0;i<hand.length;i++){
        if(sum>21 && hand.includes(11)){
            sum -= 10; // convert one ace from 11 to 1
            // remove only one conversion at a time
            // continue if still >21 and more aces
            hand[hand.indexOf(11)] = 1;
        }
    }
    return sum;
}
function updateBJState(){
    const state = document.getElementById("bjState");
    if(!bjGame) return;
    const pSum = sumHand(bjGame.player.slice());
    const dSum = sumHand([bjGame.dealer[0]]); // show only one dealer card
    state.innerHTML = `Vos cartes: ${bjGame.player.join(', ')} (total ${pSum})<br>Dealer: ${bjGame.dealer[0]}, ?`;
    if(pSum===21){
        finishBlackjack();
    }
    if(pSum>21){
        finishBlackjack();
    }
}
function hitBlackjack(){
    if(!bjGame) return;
    bjGame.player.push(drawCard(bjGame.deck));
    updateBJState();
    const pSum = sumHand(bjGame.player.slice());
    if(pSum>21) finishBlackjack();
}
function standBlackjack(){
    if(!bjGame) return;
    // dealer draws until 17
    let dSum = sumHand(bjGame.dealer.slice());
    while(dSum < 17){
        bjGame.dealer.push(drawCard(bjGame.deck));
        dSum = sumHand(bjGame.dealer.slice());
    }
    finishBlackjack();
}
function finishBlackjack(){
    document.getElementById("bjHit").style.display = 'none';
    document.getElementById("bjStand").style.display = 'none';
    if(!bjGame) return;
    const pSum = sumHand(bjGame.player.slice());
    const dSum = sumHand(bjGame.dealer.slice());
    let result = '';
    if(pSum>21){
        result = `Vous avez ${pSum} (bust). Vous perdez ${bjGame.bet.toFixed(2)} ‚Ç¨`;
        argent -= bjGame.bet;
    } else if(dSum>21){
        result = `Dealer ${dSum} (bust). Vous gagnez ${bjGame.bet.toFixed(2)} ‚Ç¨`;
        argent += bjGame.bet;
    } else if(pSum > dSum){
        result = `Vous ${pSum} vs Dealer ${dSum}. Vous gagnez ${bjGame.bet.toFixed(2)} ‚Ç¨`;
        argent += bjGame.bet;
    } else if(pSum === dSum){
        result = `√âgalit√© ${pSum}. Mise rembours√©e.`;
    } else {
        result = `Vous ${pSum} vs Dealer ${dSum}. Vous perdez ${bjGame.bet.toFixed(2)} ‚Ç¨`;
        argent -= bjGame.bet;
    }
    save();
    const state = document.getElementById("bjState");
    if(state) state.innerHTML += `<br><strong>${result}</strong>`;
    bjGame = null;
    // ne pas rediriger : rester sur la page casino pour afficher le r√©sultat
}

// ==== END CASINO ====

</script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Money Game</title>
<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #0f172a;
    color: white;
    display: flex;
}

.sidebar {
    width: 220px;
    background: #020617;
    height: 100vh;
    padding: 20px;
}

.menu-item {
    margin: 12px 0;
    cursor: pointer;
    color: #cbd5f5;
    font-weight: bold;
}
.menu-item:hover { color: #22c55e; }

.content {
    flex: 1;
    padding: 30px;
}

.card {
    background: #1e293b;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 15px;
    box-shadow: 0 0 10px rgba(0,255,0,0.2);
    transition: all 0.3s ease;
}

.card.up { box-shadow: 0 0 10px rgba(34,197,94,0.5); }
.card.down { box-shadow: 0 0 10px rgba(239,68,68,0.5); }

.action {
    display: flex;
    justify-content: space-between;
    cursor: pointer;
    padding: 10px;
}

.up { color: #22c55e; }
.down { color: #ef4444; }

canvas {
    background: #020617;
    border-radius: 10px;
    margin-top: 15px;
}

input {
    padding: 8px;
    width: 140px;
    margin-right: 10px;
}

button {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    background: #22c55e;
    color: black;
    margin-right: 5px;
    transition: all 0.2s ease;
}
button:hover { background: #16a34a; }

h1 { margin-top: 0; }

/* New styles for dashboard layout */
.row { display:flex; gap:15px; align-items:flex-start; }
.col { flex:1; }
.small { width:360px; }
.card-clickable { cursor:pointer; }
.kv { display:flex; align-items:center; justify-content:space-between; }
.meta { color:#cbd5f5; font-size:0.9em; }
.badge { background:#111827; padding:6px 10px; border-radius:8px; color:#cbd5f5; }
.quick-buttons button { padding:6px 10px; font-size:0.9em; margin-right:6px; }
.helper { color:#9ca3af; font-size:0.9em; margin-top:8px; }

/* Casino */
.casino-grid { display:flex; gap:12px; align-items:flex-start; }
.casino-col { flex:1; }
.small-input { width:100px; padding:6px; }
.center { text-align:center; }
</style>
</head>
<body>

<div class="sidebar">
    <h2>üí∞ Money Game</h2>
    <div class="menu-item" onclick="dashboard()">üè† Accueil</div>
    <div class="menu-item" onclick="investPage()">üìà Investir</div>
    <div class="menu-item" onclick="openCasino()">üé≤ Casino</div>
    <div class="menu-item" onclick="helpPage()">‚ùì Help</div>
</div>

<div class="content" id="content"></div>

<script>
// ===== VARIABLES GLOBALES =====
let currentPage = "dashboard"; // dashboard / invest / action_x / help / casino
let currentActionId = null;

let argent = localStorage.getItem("argent")
    ? parseFloat(localStorage.getItem("argent"))
    : 10000;

let portfolio = localStorage.getItem("portfolio")
    ? JSON.parse(localStorage.getItem("portfolio"))
    : {0:0,1:0,2:0};

// action definitions with names / initial prices; timers set via nextTimer
const actions = [
    loadAction(0,"Moni Invest (principal)",100),
    loadAction(1,"Crypto (secondaire)",500),
    loadAction(2,"Water Co (autre)",500)
];

// histories for charts (extended retention)
let argentHistory = localStorage.getItem("argentHistory")
    ? JSON.parse(localStorage.getItem("argentHistory"))
    : [argent];

let rankHistory = localStorage.getItem("rankHistory")
    ? JSON.parse(localStorage.getItem("rankHistory"))
    : [getRankNumeric(argent)];

// news history & active effects
let newsHistory = localStorage.getItem("newsHistory")
    ? JSON.parse(localStorage.getItem("newsHistory"))
    : [];
let activeNewsEffects = {}; // {actionId: {mult:1.2, remainingSecs:20, text:"..."} }
// Pending news effects generated at time T to be applied at the next price update of the target
let pendingNewsEffects = {}; // {actionId: {mult:..., duration:..., text:...} }

// BOTs: 5 robots starting at 3000
let bots = localStorage.getItem("bots")
    ? JSON.parse(localStorage.getItem("bots"))
    : createInitialBots();

function createInitialBots(){
    const list = [];
    // use more natural names so bots are not trivially distinguishable
    const names = ["Alexandre","Sophie","Thomas","Laura","Nicolas","Am√©lie","Julien","Camille","Maxime","Marine"];
    for(let i=0;i<5;i++){
        list.push({
            id: names[i % names.length] + (Math.random()<0.3 ? Math.floor(Math.random()*90+10) : ""), // sometimes add number to vary
            cash: 3000,
            portfolio: {0:0,1:0,2:0}
        });
    }
    localStorage.setItem("bots", JSON.stringify(list));
    return list;
}

// Build players list derived from bots + you
function updatePlayersList(){
    const players = [];
    players.push({name: "Vous", total: argent + totalPortfolioValue()});
    bots.forEach(b=>{
        const total = b.cash + botPortfolioValue(b);
        players.push({name: b.id, total: total});
    });
    // sort descending by total
    players.sort((a,b)=> b.total - a.total);
    localStorage.setItem("players", JSON.stringify(players));
    return players;
}

// save bots and players
function saveBotsAndPlayers(){
    localStorage.setItem("bots", JSON.stringify(bots));
    updatePlayersList();
}

// helper to calculate bot portfolio value
function botPortfolioValue(bot) {
    let v = 0;
    actions.forEach(a=> v += (bot.portfolio[a.id]||0)*a.prix);
    return v;
}

// loadAction / timer logic
function loadAction(id, nom, prix) {
    let saved = localStorage.getItem("action_"+id);
    if (saved) {
        let obj = JSON.parse(saved);
        // ensure name updated if code changed
        obj.nom = nom;
        return obj;
    }
    return { id, nom, prix, prev: prix, timer: nextTimer(id), history: [prix] };
}

// timers adapt√©s par action
function nextTimer(id) {
    if(id === 0) return 30;   // principal : 30s
    if(id === 1) return 60;   // secondaire : 60s
    if(id === 2) return 300;  // autre : 300s (5min)
    return Math.floor(Math.random() * 91) + 30; // fallback 30..120
}

// helper pour d√©tecter si l'utilisateur est en train d'√©crire (emp√™che le re-render)
function isUserTyping() {
    try {
        const ae = document.activeElement;
        if(!ae) return false;
        const tag = ae.tagName;
        if(tag === 'INPUT' || tag === 'TEXTAREA') return true;
        if(ae.isContentEditable) return true;
        return false;
    } catch(e) {
        return false;
    }
}

function save() {
    localStorage.setItem("argent", argent);
    localStorage.setItem("portfolio", JSON.stringify(portfolio));
    actions.forEach(a=>localStorage.setItem("action_"+a.id, JSON.stringify(a)));

    // extend retention to 10000 snapshots so we can show long timelines
    argentHistory.push(parseFloat(argent));
    if(argentHistory.length>10000) argentHistory.shift();
    localStorage.setItem("argentHistory", JSON.stringify(argentHistory));

    rankHistory.push(getRankNumeric(argent + totalPortfolioValue()));
    if(rankHistory.length>10000) rankHistory.shift();
    localStorage.setItem("rankHistory", JSON.stringify(rankHistory));

    localStorage.setItem("newsHistory", JSON.stringify(newsHistory));
    saveBotsAndPlayers();
}

// helper to calculate total portfolio value (user)
function totalPortfolioValue() {
    let v = 0;
    actions.forEach(a=> v += portfolio[a.id]*a.prix);
    return v;
}

// numeric rank for charting (higher is better)
function getRankNumeric(total) {
    if(total<10000) return 1;
    else if(total<20000) return 2;
    else if(total<50000) return 3;
    else return 4;
}

// ==== CALCUL DU RANG (texte) ====
function getRank() {
    let total = argent + totalPortfolioValue();
    if(total<10000) return "D√©butant";
    else if(total<20000) return "Amateur";
    else if(total<50000) return "Pro";
    else return "Expert";
}

// ==== DASHBOARD ====
function dashboard() {
    currentPage = "dashboard";
    updatePlayersList();
    let value = totalPortfolioValue();
    // latest news
    const latestNews = newsHistory.length? newsHistory[newsHistory.length-1].text : "Aucune news r√©cente.";

    let html = `<h1>Tableau de bord</h1>
        <div class="row">
            <div class="col small">
                <div class="card card-clickable" onclick="openMoney()"> 
                    <div class="kv">
                        <div>
                            <strong>üí∞ Argent disponible</strong><br>
                            <span class="meta">${argent.toFixed(2)} ‚Ç¨</span>
                        </div>
                        <div class="badge">${portfolioValueLabel()}</div>
                    </div>
                    <canvas id="moneyMiniChart" width="320" height="120"></canvas>
                    <div class="helper">Cliquez pour voir plus de d√©tails sur votre historique d'argent.</div>
                </div>

                <div class="card card-clickable" onclick="openStatus()">
                    <strong>üè∑Ô∏è Statut</strong><br>
                    <div style="margin-top:8px;">
                        <span style="font-size:1.1em; font-weight:bold;">${getRank()}</span>
                        <div class="helper">Cliquez pour voir les paliers de statut et seuils associ√©s.</div>
                    </div>
                </div>
            </div>

            <div class="col">
                <div class="card card-clickable" onclick="openRank()">
                    <strong>üèÖ Rang (global)</strong><br>
                    <div style="margin-top:8px;">
                        <span style="font-size:1.2em; font-weight:bold;">#1 (solo)</span>
                        <div class="helper">Cliquez pour afficher le classement des joueurs et l'√©volution du rang.</div>
                    </div>
                    <canvas id="rankMiniChart" width="600" height="120"></canvas>
                </div>

                <div class="card">
                    <strong>üíº Valeur du portefeuille</strong><br>
                    <span class="meta">${value.toFixed(2)} ‚Ç¨</span>
                    <div style="margin-top:10px;">
                        <strong>D√©tails :</strong><br>`;
    actions.forEach(a=>{
        html+=`${a.nom} : ${portfolio[a.id].toFixed(4)} parts (valeur : ${(portfolio[a.id]*a.prix).toFixed(2)} ‚Ç¨)<br>`;
    });
    html+=`</div></div>
            </div>
        </div>

        <div class="row">
            <div class="col small">
                <div class="card">
                    <strong>üì∞ News (derni√®re)</strong><br>
                    <div style="margin-top:8px;">${latestNews}</div>
                    <div class="helper">Une news appara√Æt toutes les 5 minutes et peut influencer les actions.</div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <strong>Classement rapide</strong><br>
                    <div style="margin-top:8px;">
                        <ol>`;
    const players = updatePlayersList();
    // show top 5
    players.slice(0,5).forEach(p=>{
        html+=`<li>${p.name} ‚Äî ${p.total.toFixed(2)} ‚Ç¨</li>`;
    });
    html+=`</ol>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.getElementById("content").innerHTML = html;

    // draw mini charts (more points, uses entire history window)
    drawMiniMoneyChart();
    drawMiniRankChart();
}

function portfolioValueLabel() {
    let val = totalPortfolioValue();
    if(val<1000) return `${val.toFixed(0)} ‚Ç¨ portefeuille`;
    return `${val.toFixed(2)} ‚Ç¨ portefeuille`;
}

// ==== INVEST PAGE ====
function investPage() {
    currentPage = "invest";
    let html = `<h1>Investir</h1>`;
    actions.forEach(a=>{
        let diff = (((a.prix-a.prev)/a.prev)*100).toFixed(2);
        html += `<div class="card ${diff>=0?'up':'down'} action" onclick="openAction(${a.id})">
            <div>
                <strong>${a.nom}</strong><br>
                <span class="${diff>=0?'up':'down'}">${diff>=0?'‚ñ≤':'‚ñº'} ${diff} %</span>
            </div>
            <div>‚è±Ô∏è ${a.timer}s</div>
        </div>`;
    });
    document.getElementById("content").innerHTML = html;
}

// ==== ACTION DETAIL ====
function openAction(id) {
    currentPage = "action_"+id;
    currentActionId = id;
    let a = actions[id];
    let holdingsValue = (portfolio[id]*a.prix).toFixed(2);
    document.getElementById("content").innerHTML = `
        <h1>${a.nom}</h1>
        <canvas id="chart" width="700" height="250"></canvas>

        <div class="card">
            <button onclick="drawChart(${id},60)">60 pts</button>
            <button onclick="drawChart(${id},300)">300 pts</button>
            <button onclick="drawChart(${id},1000)">1000 pts</button>
        </div>

        <div class="card">
            üí≤ Prix : ${a.prix} ‚Ç¨<br>
            üì¶ Parts : ${portfolio[id].toFixed(4)} (valeur actuelle : ${holdingsValue} ‚Ç¨)
        </div>

        <div class="card">
            <strong>Acheter</strong><br>
            <input id="buyAmount" type="number" placeholder="Montant ‚Ç¨">
            <button onclick="buy(${id})">Investir</button>
            <div class="helper">Entrez un montant en euros √† convertir au prix courant.</div>
        </div>

        <div class="card">
            <strong>Vendre</strong><br>
            <div>
                <label><input type="radio" name="sellMode" value="euro" checked> Vendre en ‚Ç¨</label>
                <label style="margin-left:12px;"><input type="radio" name="sellMode" value="parts"> Vendre en parts</label>
            </div>
            <input id="sellAmount" type="number" placeholder="Montant ‚Ç¨ ou parts selon le mode">
            <div class="quick-buttons" style="margin-top:8px;">
                <button onclick="setSellPercent(${id},25)">Vendre 25%</button>
                <button onclick="setSellPercent(${id},50)">Vendre 50%</button>
                <button onclick="setSellPercent(${id},100)">Vendre tout</button>
            </div>
            <br>
            <button onclick="sell(${id})">Ex√©cuter vente</button>
            <button onclick="sellAll(${id})" style="background:#ef4444;color:white;">Vendre tout</button>
            <div class="helper">Vous pouvez vendre par montant en ‚Ç¨ (au prix courant) ou par parts. Un clic sur "Vendre tout" vend la totalit√© de vos parts pour le montant courant.</div>
        </div>

        <div class="card">üèÖ Rang : ${getRank()}</div>

        <button onclick="investPage()">‚¨Ö Retour</button>
    `;
    drawChart(id,60);
}

// ==== setSellPercent helper ====
function setSellPercent(id, percent) {
    let a = actions[id];
    let partsOwned = portfolio[id];
    let mode = document.querySelector('input[name="sellMode"]:checked').value;
    if(mode === 'parts') {
        document.getElementById('sellAmount').value = (partsOwned * (percent/100)).toFixed(6);
    } else {
        // euros value of that percent
        let euros = partsOwned * a.prix * (percent/100);
        document.getElementById('sellAmount').value = euros.toFixed(2);
    }
}

// ==== COURBE ====
function drawChart(id, points) {
    let a = actions[id];
    let data = a.history.slice(-points);
    if(data.length<2) data = a.history; // show full if not enough
    let c = document.getElementById("chart");
    if(!c) return;
    let ctx = c.getContext("2d");
    ctx.clearRect(0,0,c.width,c.height);

    let max = Math.max(...data);
    let min = Math.min(...data);

    ctx.beginPath();
    ctx.strokeStyle = "#22c55e";
    ctx.lineWidth = 2;

    data.forEach((v,i)=>{
        let x = i*(c.width/data.length);
        let y = c.height - ((v-min)/(max-min||1))* (c.height-10) - 5;
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
    });
    ctx.stroke();
}

// mini money chart on dashboard (large window so evolution visible)
function drawMiniMoneyChart() {
    let c = document.getElementById("moneyMiniChart");
    if(!c) return;
    let ctx = c.getContext("2d");
    // show as much as available (up to 1000 points for performance)
    let data = argentHistory.slice(-1000);
    if(data.length<2) data = argentHistory;
    ctx.clearRect(0,0,c.width,c.height);
    let max = Math.max(...data);
    let min = Math.min(...data);
    ctx.beginPath();
    ctx.strokeStyle = "#60a5fa";
    ctx.lineWidth = 1.5;
    data.forEach((v,i)=>{
        let x = i*(c.width/data.length);
        let y = c.height - ((v-min)/(max-min||1))* (c.height-10) - 5;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
}

function drawMiniRankChart() {
    let c = document.getElementById("rankMiniChart");
    if(!c) return;
    let ctx = c.getContext("2d");
    let data = rankHistory.slice(-500);
    if(data.length<2) data = rankHistory;
    ctx.clearRect(0,0,c.width,c.height);
    let max = Math.max(...data);
    let min = Math.min(...data);
    ctx.beginPath();
    ctx.strokeStyle = "#fbbf24";
    ctx.lineWidth = 1.5;
    data.forEach((v,i)=>{
        let x = i*(c.width/data.length);
        let y = c.height - ((v-min)/(max-min||1))* (c.height-10) - 5;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
}

// ==== BUY / SELL ====
function buy(id) {
    let elem = document.getElementById("buyAmount");
    if(!elem) return;
    let amount = parseFloat(elem.value);
    let a = actions[id];
    if(!amount || amount<=0) return alert("Montant invalide");
    if(amount>argent) return alert("Montant sup√©rieur √† l'argent disponible");
    portfolio[id]+=amount/a.prix;
    argent-=amount;
    save();
    openAction(id);
}

// sell supports two modes: euros or parts
function sell(id) {
    let raw = parseFloat(document.getElementById("sellAmount").value);
    let a = actions[id];
    if(!raw || raw<=0) return alert("Montant invalide");
    let mode = document.querySelector('input[name="sellMode"]:checked').value;
    if(mode === 'parts') {
        if(raw>portfolio[id]) return alert("Vous n'avez pas autant de parts");
        portfolio[id]-=raw;
        let euros = raw * a.prix;
        argent+=euros;
    } else {
        // euro mode
        let parts = raw / a.prix;
        if(parts>portfolio[id]) return alert("Vous n'avez pas suffisamment de parts pour ce montant");
        portfolio[id]-=parts;
        argent+=raw;
    }
    save();
    openAction(id);
}

// sell all holdings of an action
function sellAll(id) {
    let a = actions[id];
    let parts = portfolio[id];
    if(parts<=0) return alert("Vous n'avez pas de parts √† vendre");
    let euros = parts * a.prix;
    portfolio[id]=0;
    argent+=euros;
    save();
    openAction(id);
}

// ==== HELP PAGE (COMPL√àTE) ====
function helpPage() {
    currentPage = "help";
    currentActionId = null;
    document.getElementById("content").innerHTML = `
        <h1>üìò Aide compl√®te / Manuel utilisateur</h1>

        <div class="card">
            <h3>Pr√©sentation</h3>
            <p>
                Money Game est une simulation d'investissement et de gestion d'un portefeuille avec :
                - 3 instruments d'investissement (actions) ayant des comportements diff√©rents,
                - un tableau de bord avec historique et graphiques,
                - des bots joueurs simul√©s pour compl√©ter le classement,
                - un fil de news qui peut influencer les actions,
                - un mini-casino (roulette et blackjack).
            </p>
        </div>

        <div class="card">
            <h3>Argent, Portefeuille et Total</h3>
            <ul>
                <li><strong>Argent</strong> : cash liquide disponible pour acheter. Affich√© sur le Dashboard.</li>
                <li><strong>Portefeuille</strong> : nombre de parts poss√©d√©es pour chaque action. Valeur = parts √ó prix courant.</li>
                <li><strong>Total du compte</strong> = Argent + Valeur du portefeuille. C'est ce total qui d√©termine votre rang.</li>
            </ul>
            <div class="helper">
                Les valeurs sont sauvegard√©es dans <code>localStorage</code> : argent, portfolio, historiques, bots et news.
            </div>
        </div>

        <div class="card">
            <h3>Les actions (instruments)</h3>
            <p>Il y a trois instruments principaux :</p>
            <ol>
                <li>
                    <strong>Moni Invest (principal)</strong> ‚Äî timer : 30s ‚Äî volatilit√© faible.
                    <ul>
                        <li>Comportement : variations petites et r√©guli√®res autour d'une valeur de r√©f√©rence (~100).</li>
                        <li>Objectif : instrument ¬´ stable ¬ª, faible risque/retour.</li>
                    </ul>
                </li>
                <li>
                    <strong>Crypto (secondaire)</strong> ‚Äî timer : 60s ‚Äî volatilit√© √©lev√©e.
                    <ul>
                        <li>Comportement : variations plus importantes que Moni Invest, plus de bruit.</li>
                        <li>Objectif : instrument risqu√©, opportunit√© de plus hauts gains/pertes √† court terme.</li>
                    </ul>
                </li>
                <li>
                    <strong>Water Co (autre)</strong> ‚Äî timer : 300s (5 min) ‚Äî comportement tr√®s al√©atoire.
                    <ul>
                        <li>Comportement : pas de valeur de r√©f√©rence stricte, peut fluctuer fortement.</li>
                        <li>Objectif : instrument ¬´ wild ¬ª, utile si vous voulez parier sur des mouvements importants.</li>
                    </ul>
                </li>
            </ol>
            <div class="helper">Les timers indiqu√©s sur la page Investir montrent le temps restant avant la prochaine mise √† jour du prix.</div>
        </div>

        <div class="card">
            <h3>Acheter / Investir</h3>
            <ol>
                <li>Ouvrez une action (Investir ‚Üí cliquez sur l'action).</li>
                <li>Dans la section "Acheter", entrez un montant en ‚Ç¨ dans le champ <em>Montant ‚Ç¨</em>.</li>
                <li>Cliquez sur <strong>Investir</strong> : le montant est converti en parts au prix courant et retir√© de votre argent.</li>
            </ol>
            <div class="helper">
                Remarques techniques :
                <ul>
                    <li>Si vous tapez dans un champ, l'application ne rechargera pas la vue automatiquement (emp√™che le champ de perdre le focus).</li>
                    <li>Vous ne pouvez pas investir plus que votre argent disponible ‚Äî une alerte s'affiche si vous essayez.</li>
                </ul>
            </div>
        </div>

        <div class="card">
            <h3>Vendre</h3>
            <p>Deux modes de vente :</p>
            <ul>
                <li><strong>‚Ç¨/Euro</strong> : vous entrez un montant en euros que vous voulez recevoir. Le jeu calcule combien de parts cela repr√©sente et les vend au prix courant.</li>
                <li><strong>Parts</strong> : vous entrez directement le nombre de parts √† vendre.</li>
            </ul>
            <p>Outils rapides :</p>
            <ul>
                <li>Vendre 25% / 50% / 100% : calcule automatiquement la valeur correspondante en ‚Ç¨ ou en parts selon le mode s√©lectionn√©.</li>
                <li>Vendre tout : liquide toutes vos parts pour cette action au prix courant.</li>
            </ul>
            <div class="helper">Des v√©rifications emp√™chent de vendre plus que vos parts disponibles.</div>
        </div>

        <div class="card">
            <h3>Graphiques & Historique</h3>
            <ul>
                <li>Les historiques d'argent et de prix sont conserv√©s localement (jusqu'√† 10 000 snapshots) pour permettre des graphiques longue dur√©e.</li>
                <li>Dashboard ‚Üí cliquez sur ¬´ Argent ¬ª pour voir l'historique d√©taill√© (fen√™tre longue).</li>
                <li>Page d'une action ‚Üí bouton pour s√©lectionner la fen√™tre d'affichage (60 / 300 / 1000 points).</li>
            </ul>
            <div class="helper">
                Si l'historique est long, le trac√© montrera l'√©volution du d√©but vers la fin. Pour am√©liorer la lisibilit√©, changez la fen√™tre d'affichage sur la page action.
            </div>
        </div>

        <div class="card">
            <h3>Bots (joueurs simul√©s)</h3>
            <ul>
                <li>Il y a 5 bots persistants pour simuler d'autres joueurs (noms naturels pour ne pas les distinguer facilement).</li>
                <li>Chaque bot d√©marre avec 3 000 ‚Ç¨.</li>
                <li>Comportement : achats/ventes al√©atoires et petits, √† intervalles simul√©s. Ils ne descendent jamais en dessous de 3 000 ‚Ç¨ (recapitalisation automatique si n√©cessaire).</li>
                <li>Les totaux des bots sont affich√©s dans le classement et mis √† jour r√©guli√®rement.</li>
            </ul>
            <div class="helper">Les bots sont intentionnellement simples. Si vous souhaitez des bots plus r√©alistes (r√©agissant aux news, momentum), on peut l'am√©liorer.</div>
        </div>

        <div class="card">
            <h3>News</h3>
            <ul>
                <li>Une news est g√©n√©r√©e toutes les 5 minutes (300s) par d√©faut. Par design, une news est li√©e au cycle de Water Co : elle est cr√©√©e au temps T et s'applique lors du prochain changement de prix de la cible (T+1).</li>
                <li>Chaque news contient :
                    <ul>
                        <li>un texte (ex. "P√©nurie d'eau..."),</li>
                        <li>une cible (quelle action est affect√©e),</li>
                        <li>un multiplicateur d'effet (ex. √ó1.2) et</li>
                        <li>une dur√©e d'effet (ex. 30s).</li>
                    </ul>
                </li>
                <li>Les effets sont appliqu√©s lors du prochain update de prix de l'action cibl√©e (c'est-√†-dire que la news sert d'indice avant l'effet r√©el).</li>
                <li>Les news sont visibles sur le Dashboard (section News) et sauvegard√©es dans le journal local (newsHistory).</li>
            </ul>
            <div class="helper">Utilisez les news comme indices : elles peuvent sugg√©rer d'acheter ou vendre, mais ce n'est pas une garantie.</div>
        </div>

        <div class="card">
            <h3>Casino (Roulette & Blackjack)</h3>
            <p>Le casino est accessible via la sidebar. Les deux jeux sont g√©r√©s localement et affectent directement votre <strong>Argent</strong>. Les r√©sultats s'affichent directement sur la page[...]

            <h4>Roulette</h4>
            <ul>
                <li>Options de pari : <strong>Rouge</strong>, <strong>Noir</strong> ou un <strong>Num√©ro (0‚Äì36)</strong>.</li>
                <li>Payouts :
                    <ul>
                        <li>Couleur gagnante : paiement 2√ó (vous r√©cup√©rez 2√ó votre mise, gain net = mise).</li>
                        <li>Num√©ro exact : paiement 36√ó (gain net = 35√ó votre mise).</li>
                    </ul>
                </li>
                <li>0 est trait√© comme perte pour les paris couleurs (roulette europ√©enne simplifi√©e ici avec un seul 0).</li>
                <li>R√©sultat : affich√© dans <code>#rouletteResult</code> sur la page Casino, avec montant gagn√©/perdu.</li>
                <li>V√©rifications : la mise doit √™tre positive et ‚â§ votre argent disponible.</li>
            </ul>

            <h4>Blackjack (version simplifi√©e)</h4>
            <ul>
                <li>R√®gles de base :
                    <ul>
                        <li>Vous placez une mise, recevez 2 cartes et le dealer 2 cartes (une visible).</li>
                        <li>Options : <strong>Hit</strong> (tirer) ou <strong>Stand</strong> (rester).</li>
                        <li>Les As comptent 11 ou 1 automatiquement pour √©viter le bust si possible.</li>
                        <li>Le dealer pioche jusqu'√† atteindre ‚â• 17.</li>
                        <li>R√©sultat : gain, perte ou √©galit√© ; affich√© dans <code>#bjState</code>. La mise est appliqu√©e imm√©diatement (gain = mise, perte = mise).</li>
                    </ul>
                </li>
                <li>Limites : interface simple, pas d'assurance, pas de split, blackjack naturel (21 en deux cartes) trait√© comme gain imm√©diat si possible.</li>
                <li>Restez sur la page Casino : les r√©sultats s'affichent ici et vous pouvez relancer d'autres parties.</li>
            </ul>
        </div>

        <div class="card">
            <h3>Donn√©es & Persistance</h3>
            <ul>
                <li>Toutes les donn√©es importantes sont sauvegard√©es dans <code>localStorage</code> : argent, portfolio, actions, historiques, bots et news.</li>
                <li>Si vous changez de navigateur ou videz le stockage, la progression sera perdue.</li>
                <li>Les historiques sont limit√©s (par d√©faut jusqu'√† 10 000 snapshots) pour √©viter d'utiliser trop de m√©moire.</li>
            </ul>
        </div>

        <div class="card">
            <h3>Comportements techniques importants / R√©solution de bugs</h3>
            <ul>
                <li>La page n'actualise pas automatiquement les views d'entr√©e pendant que vous tapez (focus actif sur input) ‚Äî cela √©vite que le champ perde le focus.</li>
                <li>Si vous constatez que les chiffres ou timers ne s'affichent pas correctement, attendez un tick (le moteur tourne toutes les secondes) ou rafra√Æchissez la page manuellement.</li>
                <li>Les bots sont simul√©s c√¥t√© client : ils peuvent augmenter ou diminuer, mais ne tomberont pas en dessous de 3000 ‚Ç¨.</li>
            </ul>
        </div>

        <div class="card">
            <h3>Conseils & Bonnes pratiques</h3>
            <ul>
                <li>Pour observer des tendances, utilisez le graphique complet dans "Historique de l'argent" (Dashboard ‚Üí cliquez sur Argent) ou augmentez la fen√™tre sur les pages d'actions.</li>
                <li>Moni Invest est id√©al pour une strat√©gie conservatrice ; Crypto pour des sp√©culations ; Water Co si vous aimez le risque.</li>
                <li>Utilisez les news comme un indice, pas comme une certitude.</li>
                <li>Commencez petit au casino ‚Äî c'est du hasard. Le casino est con√ßu pour le divertissement, pas pour s'enrichir facilement.</li>
            </ul>
        </div>

        <div class="card">
            <h3>Support & Am√©liorations possibles</h3>
            <p>
                Si tu veux que j'ajoute :
                <ul>
                    <li>Des bots plus intelligents (r√©actifs aux news, strat√©gies),</li>
                    <li>Des r√©glages UI pour modifier les timers (30s/60s/300s) depuis les options,</li>
                    <li>Des animations / cartes graphiques pour le blackjack,</li>
                    <li>Ou un export/import de sauvegarde ‚Äî dis-moi et je pr√©pare une PR.</li>
                </ul>
            </p>
        </div>

        <button onclick="dashboard()">‚¨Ö Retour</button>
    `;
}
 // ==== FIN HELP PAGE ====

 // ==== NEWS GENERATOR =====
// (news are now generated when Water Co updates; they are created at time T and applied on the next update of the target)
function generateNews(asPending = true){
    // sample news items that influence actions
    const pool = [
        {text: "P√©nurie d'eau signal√©e : hausse probable des actions Water Co", target:2, mult:1.20},
        {text: "Nouvelle r√®glementation favorable aux banques : l√©g√®re hausse Moni Invest", target:0, mult:1.08},
        {text: "Crash crypto mineur : Crypto chute", target:1, mult:0.80},
        {text: "Rumeur d'innovation sur Water Co : action volatille", target:2, mult:1.15},
        {text: "Crypto adopte une nouvelle tech, volatilit√© accrue", target:1, mult:1.10}
    ];
    const pick = pool[Math.floor(Math.random()*pool.length)];
    const news = { time: Date.now(), text: pick.text, target: pick.target, mult: pick.mult, duration: 30 }; // effect lasts 30s
    newsHistory.push(news);
    if(newsHistory.length>200) newsHistory.shift();

    if(asPending){
        // create a pending effect that will be applied at the next update of the target action
        pendingNewsEffects[pick.target] = { mult: pick.mult, duration: news.duration, text: pick.text };
    } else {
        // immediate activation (kept for flexibility)
        activeNewsEffects[pick.target] = { mult: pick.mult, remainingSecs: news.duration, text: pick.text };
    }
    localStorage.setItem("newsHistory", JSON.stringify(newsHistory));
    return news;
}

// ==== BOT SIMULATION ====
function simulateBots() {
    bots.forEach(bot=>{
        // small probability each second to act
        if(Math.random() < 0.02){ // ~ once every 50s per bot on average
            const actionId = Math.floor(Math.random()*actions.length);
            const a = actions[actionId];
            // choose buy or sell (50/50)
            if(Math.random()<0.5){
                // buy small amount (10..150)
                let amount = Math.round((Math.random()*140)+10);
                // ensure bot cash doesn't drop below 3000
                if(bot.cash - amount < 3000) {
                    amount = Math.max(0, Math.floor(bot.cash - 3000));
                }
                if(amount>0){
                    bot.portfolio[actionId] = (bot.portfolio[actionId]||0) + (amount / a.prix);
                    bot.cash -= amount;
                }
            } else {
                // sell small percent of holdings
                const parts = bot.portfolio[actionId] || 0;
                if(parts>0){
                    const pct = (Math.random()*0.6); // sell up to 60%
                    const sellParts = parts * pct;
                    bot.portfolio[actionId] = Math.max(0, parts - sellParts);
                    bot.cash += sellParts * a.prix;
                }
            }
        }
        // ensure bot total doesn't drop below 3000: top-up if market drop made them <3000
        const total = bot.cash + botPortfolioValue(bot);
        if(total < 3000){
            bot.cash += (3000 - total);
        }
    });
    saveBotsAndPlayers();
}

// ==== MARKET LOOP =====
// volatility map per action id
const volMap = {
    0: 0.02,  // Moni Invest stable ~2%
    1: 0.12,  // Crypto volatile ~12%
    2: 0.40   // Water Co very random ~40% (could be large)
};

setInterval(()=>{
    // decrement active news effects
    Object.keys(activeNewsEffects).forEach(k=>{
        activeNewsEffects[k].remainingSecs--;
        if(activeNewsEffects[k].remainingSecs<=0) delete activeNewsEffects[k];
    });

    actions.forEach(a=>{
        a.timer--;
        if(a.timer<=0){
            a.prev = a.prix;

            // If there is a pending news for this action, move it to active and apply on this update
            let effect = activeNewsEffects[a.id];
            if(pendingNewsEffects[a.id]){
                const p = pendingNewsEffects[a.id];
                // activate now
                activeNewsEffects[a.id] = {mult: p.mult, remainingSecs: p.duration, text: p.text};
                effect = activeNewsEffects[a.id];
                delete pendingNewsEffects[a.id];
            }

            // compute volatility influenced by news effects
            const baseVol = volMap[a.id] || 0.1;
            let mult = 1;
            if(effect) mult = effect.mult;

            // different strategies per action:
            if(a.id === 0){
                // Moni Invest: small gaussian-ish change around baseVol,
                // constrained to reference 100 ¬± 50 => [50,150]
                const changeFactor = 1 + ((Math.random()*2-1) * baseVol) * (Math.random()*0.8 + 0.6);
                let newPrice = Math.round(a.prix * changeFactor * mult);
                // clamp around reference
                const min0 = 50, max0 = 150;
                newPrice = Math.max(min0, Math.min(max0, newPrice));
                a.prix = Math.max(5, newPrice);
            } else if(a.id === 1){
                // Crypto: larger swings, reference 500, amplitude 300 => [200,800]
                let drift = 1 + ((500 - a.prix) / 10000); // slight pull to 500
                const change = 1 + ((Math.random()*2-1) * baseVol);
                let newPrice = Math.round(a.prix * change * drift * mult);
                const min1 = 200, max1 = 800;
                newPrice = Math.max(min1, Math.min(max1, newPrice));
                a.prix = Math.max(2, newPrice);
            } else {
                // Water Co / other: very random, can change a lot
                const change = 1 + ((Math.random()*2-1) * baseVol);
                a.prix = Math.max(1, Math.round(a.prix * change * mult));
            }

            // keep history and cap
            a.history.push(a.prix);
            if(a.history.length>10000) a.history.shift();
            // if the action that just hit timer was Water Co (id 2), generate a news now to be applied on next update of its target
            if(a.id === 2){
                generateNews(true); // create pending news (applied on next update of its target)
            }
            // reset timer per action
            a.timer = nextTimer(a.id);
            save();
        }
    });

    // simulate bots occasionally
    simulateBots();

    // update UI only if user not typing
    if(!isUserTyping()){
        if(currentPage === "invest") investPage();
        if(currentPage && currentPage.startsWith("action_")) openAction(currentActionId);
        if(currentPage === "dashboard") dashboard(); // refresh small data like timers
    }

    // periodic snapshot for charts
    argentHistory.push(parseFloat(argent));
    if(argentHistory.length>10000) argentHistory.shift();
    rankHistory.push( getRankNumeric(argent + totalPortfolioValue()) );
    if(rankHistory.length>10000) rankHistory.shift();
    localStorage.setItem("argentHistory", JSON.stringify(argentHistory));
    localStorage.setItem("rankHistory", JSON.stringify(rankHistory));
    localStorage.setItem("newsHistory", JSON.stringify(newsHistory));
    localStorage.setItem("bots", JSON.stringify(bots));
},1000);

// ==== START ====
updatePlayersList();
dashboard();

// ===== CASINO IMPLEMENTATION (Roulette + Blackjack) =====
function openCasino(){
    currentPage = "casino";
    document.getElementById("content").innerHTML = `
        <h1>üé≤ Casino</h1>
        <div class="casino-grid">
            <div class="casino-col card">
                <h3>Roulette</h3>
                <div>
                    <label>Mise (‚Ç¨): <input id="rouletteBet" class="small-input" type="number" value="10"></label>
                </div>
                <div style="margin-top:8px;">
                    <button onclick="playRoulette('red')">Parier Rouge</button>
                    <button onclick="playRoulette('black')">Parier Noir</button>
                    <button onclick="openRouletteNumberInput()">Parier N¬∞</button>
                </div>
                <div id="rouletteNumberInput" style="display:none;margin-top:8px;">
                    <label>N¬∞ (0-36): <input id="rouletteNumber" class="small-input" type="number" min="0" max="36"></label>
                    <button onclick="playRoulette('number')">Parier N¬∞</button>
                </div>
                <div id="rouletteResult" class="helper" style="margin-top:10px;"></div>
            </div>

            <div class="casino-col card">
                <h3>Blackjack</h3>
                <div>
                    <label>Mise (‚Ç¨): <input id="bjBet" class="small-input" type="number" value="20"></label>
                </div>
                <div style="margin-top:8px;">
                    <button onclick="startBlackjack()">D√©marrer</button>
                    <button onclick="hitBlackjack()" id="bjHit" style="display:none;">Hit</button>
                    <button onclick="standBlackjack()" id="bjStand" style="display:none;">Stand</button>
                </div>
                <div id="bjState" class="helper" style="margin-top:10px;"></div>
            </div>
        </div>
        <br>
        <button onclick="dashboard()">‚¨Ö Retour</button>
    `;
}

// Roulette helpers
function openRouletteNumberInput(){ document.getElementById('rouletteNumberInput').style.display='block'; }
function playRoulette(mode){
    let bet = parseFloat(document.getElementById("rouletteBet").value);
    if(!bet || bet<=0) return alert("Montant invalide");
    if(bet>argent) return alert("Pas assez d'argent");
    let number = Math.floor(Math.random()*37); // 0..36
    const redNumbers = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]); // approximate mapping
    let resultText = `La bille tombe sur ${number} (${ redNumbers.has(number) ? 'rouge' : (number===0? 'vert' : 'noir') }). `;
    let win = 0;
    if(mode === 'red' || mode === 'black'){
        if(number===0){
            win = 0;
        } else {
            const isRed = redNumbers.has(number);
            if((mode==='red' && isRed) || (mode==='black' && !isRed)) win = bet * 2;
        }
    } else if(mode === 'number'){
        const pick = parseInt(document.getElementById("rouletteNumber").value);
        if(isNaN(pick) || pick<0 || pick>36) return alert("Num√©ro invalide");
        if(pick === number) win = bet * 36;
    }
    if(win>0){
        argent += (win - bet);
        resultText += `Vous gagnez ${ (win - bet).toFixed(2) } ‚Ç¨ (retour total ${win.toFixed(2)} ‚Ç¨).`;
    } else {
        argent -= bet;
        resultText += `Vous perdez ${bet.toFixed(2)} ‚Ç¨.`;
    }
    save();
    // afficher le r√©sultat sur la page Casino sans rediriger
    const el = document.getElementById("rouletteResult");
    if(el) el.innerText = resultText;
    // rester sur la page casino; timers/UI seront rafra√Æchis par la boucle principale
}

// Simple Blackjack implementation
let bjGame = null;

function createDeck(){
    const ranks = ['A','2','3','4','5','6','7','8','9','10','J','Q','K'];
    const suits = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
    const deck = [];
    for(const r of ranks){
        for(const s of suits){
            deck.push(r + s);
        }
    }
    return shuffleArray(deck);
}

function shuffleArray(arr){
    for(let i = arr.length -1; i>0; i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

function drawCard(deck){
    if(deck.length === 0) return null;
    return deck.pop();
}

function handValue(hand){
    // hand: array of card strings like "A‚ô†", "10‚ô•", "K‚ô£"
    let total = 0;
    let aces = 0;
    hand.forEach(c=>{
        const rank = c.slice(0, c.length-1);
        if(rank === 'A'){ total += 11; aces++; }
        else if(['K','Q','J'].includes(rank)) total += 10;
        else total += parseInt(rank);
    });
    // lower ace values if bust
    while(total > 21 && aces > 0){
        total -= 10;
        aces--;
    }
    return total;
}

function renderBJState(revealDealer=false){
    const el = document.getElementById("bjState");
    if(!el) return;
    const g = bjGame;
    if(!g) { el.innerText = ""; return; }

    const playerCards = g.player.join(' ');
    let dealerCards = "";
    if(revealDealer){
        dealerCards = g.dealer.join(' ');
    } else {
        // hide dealer second card
        if(g.dealer.length > 0){
            dealerCards = g.dealer[0] + (g.dealer.length>1 ? " [‚ô•]" : "");
        }
    }
    const playerVal = handValue(g.player);
    const dealerVal = revealDealer ? handValue(g.dealer) : "?";

    el.innerHTML = `<strong>Vous</strong> : ${playerCards} ‚Äî <strong>${playerVal}</strong><br><strong>Dealer</strong> : ${dealerCards} ‚Äî <strong>${dealerVal}</strong>`;
}

function startBlackjack(){
    let bet = parseFloat(document.getElementById("bjBet").value);
    if(!bet || bet<=0) return alert("Montant invalide");
    if(bet>argent) return alert("Pas assez d'argent");
    // Deduct bet now (mise appliqu√©e imm√©diatement)
    argent -= bet;
    bjGame = {
        bet: bet,
        deck: createDeck(),
        player: [],
        dealer: [],
        finished: false
    };
    // initial deal: 2 cards each
    bjGame.player.push(drawCard(bjGame.deck));
    bjGame.dealer.push(drawCard(bjGame.deck));
    bjGame.player.push(drawCard(bjGame.deck));
    bjGame.dealer.push(drawCard(bjGame.deck));

    // show buttons
    const hitBtn = document.getElementById("bjHit");
    const standBtn = document.getElementById("bjStand");
    if(hitBtn) hitBtn.style.display = 'inline-block';
    if(standBtn) standBtn.style.display = 'inline-block';

    renderBJState(false);

    // immediate checks: blackjack
    const pVal = handValue(bjGame.player);
    if(pVal === 21){
        // player blackjack ‚Äî consider immediate win
        setTimeout(()=> {
            // payoff: for simplicity pay 2x (same as win)
            argent += bjGame.bet * 2;
            save();
            endBJGame('win','Blackjack ! Vous gagnez.');
        }, 300);
    } else {
        save();
    }
}

function hitBlackjack(){
    if(!bjGame || bjGame.finished) return;
    const card = drawCard(bjGame.deck);
    if(card) bjGame.player.push(card);
    renderBJState(false);
    const pVal = handValue(bjGame.player);
    if(pVal > 21){
        // player bust
        bjGame.finished = true;
        // bet was already deducted; no refund
        save();
        endBJGame('lose','Vous avez d√©pass√© 21. Perdu.');
    } else if(pVal === 21){
        // auto-stand
        standBlackjack();
    } else {
        save();
    }
}

function standBlackjack(){
    if(!bjGame || bjGame.finished) return;
    // reveal dealer and play dealer rules: hit until >=17
    while(handValue(bjGame.dealer) < 17){
        const c = drawCard(bjGame.deck);
        if(c) bjGame.dealer.push(c);
    }
    const pVal = handValue(bjGame.player);
    const dVal = handValue(bjGame.dealer);

    let result = 'push';
    let message = '√âgalit√©.';
    if(dVal > 21){
        // dealer bust -> player wins
        result = 'win';
        message = 'Dealer d√©passe 21 ‚Äî vous gagnez.';
        argent += bjGame.bet * 2;
    } else if(pVal > dVal){
        result = 'win';
        message = 'Vous gagnez.';
        argent += bjGame.bet * 2;
    } else if(pVal < dVal){
        result = 'lose';
        message = 'Vous perdez.';
        // bet was already deducted
    } else {
        // push: refund bet
        result = 'push';
        message = '√âgalit√© ‚Äî mise rembours√©e.';
        argent += bjGame.bet;
    }

    bjGame.finished = true;
    save();
    // hide buttons
    const hitBtn = document.getElementById("bjHit");
    const standBtn = document.getElementById("bjStand");
    if(hitBtn) hitBtn.style.display = 'none';
    if(standBtn) standBtn.style.display = 'none';

    renderBJState(true);
    endBJGame(result, message);
}

function endBJGame(result, message){
    const el = document.getElementById("bjState");
    if(el){
        el.innerHTML += `<br><strong>${message}</strong> (solde : ${argent.toFixed(2)} ‚Ç¨)`;
    }
    // clear bjGame after short delay to allow player to read
    setTimeout(()=>{
        bjGame = null;
        if(document.getElementById("bjHit")) document.getElementById("bjHit").style.display = 'none';
        if(document.getElementById("bjStand")) document.getElementById("bjStand").style.display = 'none';
        // keep user on casino page; main loop saves and refreshes
    }, 1500);
}

</script>
</body>
</html>

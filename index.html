<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Money Game</title>
<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #0f172a;
    color: white;
    display: flex;
}

.sidebar {
    width: 220px;
    background: #020617;
    height: 100vh;
    padding: 20px;
}

.menu-item {
    margin: 12px 0;
    cursor: pointer;
    color: #cbd5f5;
    font-weight: bold;
}
.menu-item:hover { color: #22c55e; }

.content {
    flex: 1;
    padding: 30px;
}

.card {
    background: #1e293b;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 15px;
    box-shadow: 0 0 10px rgba(0,255,0,0.2);
    transition: all 0.3s ease;
}

.card.up { box-shadow: 0 0 10px rgba(34,197,94,0.5); }
.card.down { box-shadow: 0 0 10px rgba(239,68,68,0.5); }

.action {
    display: flex;
    justify-content: space-between;
    cursor: pointer;
    padding: 10px;
}

.up { color: #22c55e; }
.down { color: #ef4444; }

canvas {
    background: #020617;
    border-radius: 10px;
    margin-top: 15px;
}

input {
    padding: 8px;
    width: 140px;
    margin-right: 10px;
}

button {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    background: #22c55e;
    color: black;
    margin-right: 5px;
    transition: all 0.2s ease;
}
button:hover { background: #16a34a; }

h1 { margin-top: 0; }

/* New styles for dashboard layout */
.row { display:flex; gap:15px; align-items:flex-start; }
.col { flex:1; }
.small { width:360px; }
.card-clickable { cursor:pointer; }
.kv { display:flex; align-items:center; justify-content:space-between; }
.meta { color:#cbd5f5; font-size:0.9em; }
.badge { background:#111827; padding:6px 10px; border-radius:8px; color:#cbd5f5; }
.quick-buttons button { padding:6px 10px; font-size:0.9em; margin-right:6px; }
.helper { color:#9ca3af; font-size:0.9em; margin-top:8px; }

/* Casino */
.casino-grid { display:flex; gap:12px; align-items:flex-start; }
.casino-col { flex:1; }
.small-input { width:100px; padding:6px; }
.center { text-align:center; }

/* highlight user in ranking */
.rank-you { background:#0b1220; border-left:4px solid #22c55e; padding:6px; border-radius:6px; }
</style>
</head>
<body>

<div class="sidebar">
    <h2>üí∞ Money Game</h2>
    <div class="menu-item" onclick="dashboard()">üè† Accueil</div>
    <div class="menu-item" onclick="investPage()">üìà Investir</div>
    <div class="menu-item" onclick="openCasino()">üé≤ Casino</div>
    <div class="menu-item" onclick="helpPage()">‚ùì Help</div>
</div>

<div class="content" id="content"></div>

<script>
// ===== VARIABLES GLOBALES =====
let currentPage = "dashboard"; // dashboard / invest / action_x / help / casino
let currentActionId = null;

let argent = localStorage.getItem("argent")
    ? parseFloat(localStorage.getItem("argent"))
    : 10000;

let portfolio = localStorage.getItem("portfolio")
    ? JSON.parse(localStorage.getItem("portfolio"))
    : {0:0,1:0,2:0};

// actions: Moni Invest (0) ref 100, Crypto (1) ref 500, Water Co (2) random
const actions = [
    loadAction(0,"Moni Invest (principal)",100),
    loadAction(1,"Crypto (secondaire)",500),
    loadAction(2,"Water Co (autre)",500)
];

// histories for charts (extended retention)
let argentHistory = localStorage.getItem("argentHistory")
    ? JSON.parse(localStorage.getItem("argentHistory"))
    : [argent];

let rankHistory = localStorage.getItem("rankHistory")
    ? JSON.parse(localStorage.getItem("rankHistory"))
    : [getRankNumeric(argent)];

// news history & queued effects: queuedNewsEffects[actionId] applies on next update of that action
let newsHistory = localStorage.getItem("newsHistory")
    ? JSON.parse(localStorage.getItem("newsHistory"))
    : [];
let queuedNewsEffects = localStorage.getItem("queuedNewsEffects")
    ? JSON.parse(localStorage.getItem("queuedNewsEffects"))
    : {};

// BOTs: 5 robots starting at 3000 with realistic names
let bots = localStorage.getItem("bots")
    ? JSON.parse(localStorage.getItem("bots"))
    : createInitialBots();

function createInitialBots(){
    const names = ["L√©a","Alex","Samir","Jules","Maya","Noa","Camille","In√®s","Romain","Claire"];
    const list = [];
    // pick 5 unique names
    const used = new Set();
    for(let i=0;i<5;i++){
        let n = names[i % names.length];
        used.add(n);
        list.push({
            name: n,
            cash: 3000,
            portfolio: {0:0,1:0,2:0}
        });
    }
    localStorage.setItem("bots", JSON.stringify(list));
    return list;
}

// Build players list derived from bots + you
function updatePlayersList(){
    const players = [];
    players.push({name: "Vous", total: argent + totalPortfolioValue()});
    bots.forEach(b=>{
        const total = b.cash + botPortfolioValue(b);
        players.push({name: b.name, total: total});
    });
    localStorage.setItem("players", JSON.stringify(players));
    return players;
}

function saveBotsAndPlayers(){
    localStorage.setItem("bots", JSON.stringify(bots));
    updatePlayersList();
}

// helper to calculate bot portfolio value
function botPortfolioValue(bot) {
    let v = 0;
    actions.forEach(a=> v += (bot.portfolio[a.id]||0)*a.prix);
    return v;
}

// loadAction / timer logic
function loadAction(id, nom, prix) {
    let saved = localStorage.getItem("action_"+id);
    if (saved) {
        let obj = JSON.parse(saved);
        obj.nom = nom; // keep name in sync
        return obj;
    }
    return { id, nom, prix, prev: prix, timer: nextTimer(id), history: [prix] };
}

// timers adapt√©s par action
function nextTimer(id) {
    if(id === 0) return 30;   // principal : 30s
    if(id === 1) return 60;   // secondaire : 60s
    if(id === 2) return 300;  // autre : 300s (5min)
    return Math.floor(Math.random() * 91) + 30; // fallback 30..120
}

// helper pour d√©tecter si l'utilisateur est en train d'√©crire (emp√™che le re-render)
function isUserTyping() {
    try {
        const ae = document.activeElement;
        if(!ae) return false;
        const tag = ae.tagName;
        if(tag === 'INPUT' || tag === 'TEXTAREA') return true;
        if(ae.isContentEditable) return true;
        return false;
    } catch(e) {
        return false;
    }
}

function save() {
    localStorage.setItem("argent", argent);
    localStorage.setItem("portfolio", JSON.stringify(portfolio));
    actions.forEach(a=>localStorage.setItem("action_"+a.id, JSON.stringify(a)));

    // extend retention to 10000 snapshots so we can show long timelines
    argentHistory.push(parseFloat(argent));
    if(argentHistory.length>10000) argentHistory.shift();
    localStorage.setItem("argentHistory", JSON.stringify(argentHistory));

    rankHistory.push(getRankNumeric(argent + totalPortfolioValue()));
    if(rankHistory.length>10000) rankHistory.shift();
    localStorage.setItem("rankHistory", JSON.stringify(rankHistory));

    localStorage.setItem("newsHistory", JSON.stringify(newsHistory));
    localStorage.setItem("queuedNewsEffects", JSON.stringify(queuedNewsEffects));
    saveBotsAndPlayers();
}

// helper to calculate total portfolio value (user)
function totalPortfolioValue() {
    let v = 0;
    actions.forEach(a=> v += portfolio[a.id]*a.prix);
    return v;
}

function getRankNumeric(total) {
    if(total<10000) return 1;
    else if(total<20000) return 2;
    else if(total<50000) return 3;
    else return 4;
}

function getRank() {
    let total = argent + totalPortfolioValue();
    if(total<10000) return "D√©butant";
    else if(total<20000) return "Amateur";
    else if(total<50000) return "Pro";
    else return "Expert";
}

// ==== DASHBOARD ====
function dashboard() {
    currentPage = "dashboard";
    updatePlayersList();
    let value = totalPortfolioValue();
    const latestNews = newsHistory.length? newsHistory[newsHistory.length-1].text : "Aucune news r√©cente.";

    let html = `<h1>Tableau de bord</h1>
        <div class="row">
            <div class="col small">
                <div class="card card-clickable" onclick="openMoney()"> 
                    <div class="kv">
                        <div>
                            <strong>üí∞ Argent disponible</strong><br>
                            <span class="meta">${argent.toFixed(2)} ‚Ç¨</span>
                        </div>
                        <div class="badge">${portfolioValueLabel()}</div>
                    </div>
                    <canvas id="moneyMiniChart" width="320" height="120"></canvas>
                    <div class="helper">Cliquez pour voir plus de d√©tails sur votre historique d'argent.</div>
                </div>

                <div class="card card-clickable" onclick="openStatus()">
                    <strong>üè∑Ô∏è Statut</strong><br>
                    <div style="margin-top:8px;">
                        <span style="font-size:1.1em; font-weight:bold;">${getRank()}</span>
                        <div class="helper">Cliquez pour voir les paliers de statut et seuils associ√©s.</div>
                    </div>
                </div>
            </div>

            <div class="col">
                <div class="card card-clickable" onclick="openRank()">
                    <strong>üèÖ Rang (global)</strong><br>
                    <div style="margin-top:8px;">
                        <span style="font-size:1.2em; font-weight:bold;">#1 (solo)</span>
                        <div class="helper">Cliquez pour afficher le classement complet des joueurs et votre position.</div>
                    </div>
                    <canvas id="rankMiniChart" width="600" height="120"></canvas>
                </div>

                <div class="card card-clickable" onclick="openPortfolioDetails()">
                    <strong>üíº Valeur du portefeuille</strong><br>
                    <span class="meta">${value.toFixed(2)} ‚Ç¨</span>
                    <div style="margin-top:10px;">
                        <strong>D√©tails :</strong><br>`;
    actions.forEach(a=>{
        html+=`${a.nom} : ${portfolio[a.id].toFixed(4)} parts (valeur : ${(portfolio[a.id]*a.prix).toFixed(2)} ‚Ç¨)<br>`;
    });
    html+=`</div></div>
            </div>
        </div>

        <div class="row">
            <div class="col small">
                <div class="card card-clickable" onclick="openNews()">
                    <strong>üì∞ News (derni√®re)</strong><br>
                    <div style="margin-top:8px;">${latestNews}</div>
                    <div class="helper">Les news sont publi√©es lorsque Water Co change et s'appliquent sur le prochain tick de l'action cibl√©e.</div>
                </div>
            </div>
            <div class="col">
                <div class="card">
                    <strong>Classement rapide</strong><br>
                    <div style="margin-top:8px;">
                        <ol>`;
    const players = updatePlayersList().slice().sort((a,b)=>b.total - a.total);
    players.slice(0,5).forEach(p=>{
        html+=`<li>${p.name} ‚Äî ${p.total.toFixed(2)} ‚Ç¨</li>`;
    });
    html+=`</ol>
                    </div>
                </div>
            </div>
        </div>
    `;
    document.getElementById("content").innerHTML = html;

    drawMiniMoneyChart();
    drawMiniRankChart();
}

function portfolioValueLabel() {
    let val = totalPortfolioValue();
    if(val<1000) return `${val.toFixed(0)} ‚Ç¨ portefeuille`;
    return `${val.toFixed(2)} ‚Ç¨ portefeuille`;
}

// ==== INVEST PAGE ====
function investPage() {
    currentPage = "invest";
    let html = `<h1>Investir</h1>`;
    actions.forEach(a=>{
        let diff = (((a.prix-a.prev)/ (a.prev||1))*100).toFixed(2);
        html += `<div class="card ${diff>=0?'up':'down'} action" onclick="openAction(${a.id})">
            <div>
                <strong>${a.nom}</strong><br>
                <span class="${diff>=0?'up':'down'}">${diff>=0?'‚ñ≤':'‚ñº'} ${diff} %</span>
            </div>
            <div>‚è±Ô∏è ${a.timer}s</div>
        </div>`;
    });
    document.getElementById("content").innerHTML = html;
}

// ==== ACTION DETAIL ====
function openAction(id) {
    currentPage = "action_"+id;
    currentActionId = id;
    let a = actions[id];
    let holdingsValue = (portfolio[id]*a.prix).toFixed(2);
    document.getElementById("content").innerHTML = `
        <h1>${a.nom}</h1>
        <canvas id="chart" width="700" height="250"></canvas>

        <div class="card">
            <button onclick="drawChart(${id},60)">60 pts</button>
            <button onclick="drawChart(${id},300)">300 pts</button>
            <button onclick="drawChart(${id},1000)">1000 pts</button>
        </div>

        <div class="card">
            üí≤ Prix : ${a.prix} ‚Ç¨<br>
            üì¶ Parts : ${portfolio[id].toFixed(4)} (valeur actuelle : ${holdingsValue} ‚Ç¨)
        </div>

        <div class="card">
            <strong>Acheter</strong><br>
            <input id="buyAmount" type="number" placeholder="Montant ‚Ç¨">
            <button onclick="buy(${id})">Investir</button>
            <div class="helper">Entrez un montant en euros √† convertir au prix courant.</div>
        </div>

        <div class="card">
            <strong>Vendre</strong><br>
            <div>
                <label><input type="radio" name="sellMode" value="euro" checked> Vendre en ‚Ç¨</label>
                <label style="margin-left:12px;"><input type="radio" name="sellMode" value="parts"> Vendre en parts</label>
            </div>
            <input id="sellAmount" type="number" placeholder="Montant ‚Ç¨ ou parts selon le mode">
            <div class="quick-buttons" style="margin-top:8px;">
                <button onclick="setSellPercent(${id},25)">Vendre 25%</button>
                <button onclick="setSellPercent(${id},50)">Vendre 50%</button>
                <button onclick="setSellPercent(${id},100)">Vendre tout</button>
            </div>
            <br>
            <button onclick="sell(${id})">Ex√©cuter vente</button>
            <button onclick="sellAll(${id})" style="background:#ef4444;color:white;">Vendre tout</button>
            <div class="helper">Vous pouvez vendre par montant en ‚Ç¨ (au prix courant) ou par parts. Un clic sur "Vendre tout" vend la totalit√© de vos parts pour le montant courant.</div>
        </div>

        <div class="card">üèÖ Rang : ${getRank()}</div>

        <button onclick="investPage()">‚¨Ö Retour</button>
    `;
    drawChart(id,60);
}

// ==== setSellPercent helper ====
function setSellPercent(id, percent) {
    let a = actions[id];
    let partsOwned = portfolio[id];
    let mode = document.querySelector('input[name="sellMode"]:checked').value;
    if(mode === 'parts') {
        document.getElementById('sellAmount').value = (partsOwned * (percent/100)).toFixed(6);
    } else {
        // euros value of that percent
        let euros = partsOwned * a.prix * (percent/100);
        document.getElementById('sellAmount').value = euros.toFixed(2);
    }
}

// ==== COURBE ====
function drawChart(id, points) {
    let a = actions[id];
    let data = a.history.slice(-points);
    if(data.length<2) data = a.history; // show full if not enough
    let c = document.getElementById("chart");
    if(!c) return;
    let ctx = c.getContext("2d");
    ctx.clearRect(0,0,c.width,c.height);

    let max = Math.max(...data);
    let min = Math.min(...data);

    ctx.beginPath();
    ctx.strokeStyle = "#22c55e";
    ctx.lineWidth = 2;

    data.forEach((v,i)=>{
        let x = i*(c.width/data.length);
        let y = c.height - ((v-min)/(max-min||1))* (c.height-10) - 5;
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
    });
    ctx.stroke();
}

// mini money chart on dashboard (large window so evolution visible)
function drawMiniMoneyChart() {
    let c = document.getElementById("moneyMiniChart");
    if(!c) return;
    let ctx = c.getContext("2d");
    let data = argentHistory.slice(-1000);
    if(data.length<2) data = argentHistory;
    ctx.clearRect(0,0,c.width,c.height);
    let max = Math.max(...data);
    let min = Math.min(...data);
    ctx.beginPath();
    ctx.strokeStyle = "#60a5fa";
    ctx.lineWidth = 1.5;
    data.forEach((v,i)=>{
        let x = i*(c.width/data.length);
        let y = c.height - ((v-min)/(max-min||1))* (c.height-10) - 5;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
}

function drawMiniRankChart() {
    let c = document.getElementById("rankMiniChart");
    if(!c) return;
    let ctx = c.getContext("2d");
    let data = rankHistory.slice(-500);
    if(data.length<2) data = rankHistory;
    ctx.clearRect(0,0,c.width,c.height);
    let max = Math.max(...data);
    let min = Math.min(...data);
    ctx.beginPath();
    ctx.strokeStyle = "#fbbf24";
    ctx.lineWidth = 1.5;
    data.forEach((v,i)=>{
        let x = i*(c.width/data.length);
        let y = c.height - ((v-min)/(max-min||1))* (c.height-10) - 5;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
}

// ==== BUY / SELL ====
function buy(id) {
    let elem = document.getElementById("buyAmount");
    if(!elem) return;
    let amount = parseFloat(elem.value);
    let a = actions[id];
    if(!amount || amount<=0) return alert("Montant invalide");
    if(amount>argent) return alert("Montant sup√©rieur √† l'argent disponible");
    portfolio[id]+=amount/a.prix;
    argent-=amount;
    save();
    openAction(id);
}

// sell supports two modes: euros or parts
function sell(id) {
    let raw = parseFloat(document.getElementById("sellAmount").value);
    let a = actions[id];
    if(!raw || raw<=0) return alert("Montant invalide");
    let mode = document.querySelector('input[name="sellMode"]:checked').value;
    if(mode === 'parts') {
        if(raw>portfolio[id]) return alert("Vous n'avez pas autant de parts");
        portfolio[id]-=raw;
        let euros = raw * a.prix;
        argent+=euros;
    } else {
        // euro mode
        let parts = raw / a.prix;
        if(parts>portfolio[id]) return alert("Vous n'avez pas suffisamment de parts pour ce montant");
        portfolio[id]-=parts;
        argent+=raw;
    }
    save();
    openAction(id);
}

// sell all holdings of an action
function sellAll(id) {
    let a = actions[id];
    let parts = portfolio[id];
    if(parts<=0) return alert("Vous n'avez pas de parts √† vendre");
    let euros = parts * a.prix;
    portfolio[id]=0;
    argent+=euros;
    save();
    openAction(id);
}

// ==== NEWS / DETAILS PAGES ====
function openNews(){
    currentPage = "news";
    let html = `<h1>üì∞ Journal des news</h1>
        <div class="card">
            <strong>Derni√®res news (les plus r√©centes en haut)</strong><br>
            <ol>`;
    const recent = newsHistory.slice().reverse();
    recent.forEach(n=>{
        html += `<li>${new Date(n.time).toLocaleString()} ‚Äî ${n.text} (cible: ${actions[n.target].nom})</li>`;
    });
    html += `</ol>
        <div class="helper">Les news sont g√©n√©r√©es quand Water Co change ; elles sont appliqu√©es au prochain changement de l'action cibl√©e.</div>
        </div>
        <button onclick="dashboard()">‚¨Ö Retour</button>`;
    document.getElementById("content").innerHTML = html;
}

function openPortfolioDetails(){
    currentPage = "portfolio";
    let html = `<h1>üíº D√©tails du portefeuille</h1>
    <div class="card">`;
    actions.forEach(a=>{
        html += `<strong>${a.nom}</strong><br>Prix actuel : ${a.prix} ‚Ç¨<br>Parts poss√©d√©es : ${portfolio[a.id].toFixed(6)} (valeur : ${(portfolio[a.id]*a.prix).toFixed(2)} ‚Ç¨)<br><br>`;
    });
    html += `</div><button onclick="dashboard()">‚¨Ö Retour</button>`;
    document.getElementById("content").innerHTML = html;
}

// openRank now shows full list and highlights user's rank
function openRank(){
    currentPage = "rank";
    const players = updatePlayersList().slice().sort((a,b)=>b.total - a.total);
    let youIndex = players.findIndex(p=>p.name==="Vous");
    let html = `<h1>Classement complet</h1>
        <div class="card">
            <strong>Classement</strong><br><ol>`;
    players.forEach((p, idx)=>{
        if(p.name === "Vous"){
            html += `<li class="rank-you">#${idx+1} ${p.name} ‚Äî ${p.total.toFixed(2)} ‚Ç¨</li>`;
        } else {
            html += `<li>#${idx+1} ${p.name} ‚Äî ${p.total.toFixed(2)} ‚Ç¨</li>`;
        }
    });
    html += `</ol>
            <div class="helper">Votre rang actuel : <strong>#${youIndex+1}</strong></div>
        </div>
        <button onclick="dashboard()">‚¨Ö Retour</button>`;
    document.getElementById("content").innerHTML = html;
}

// ==== NEWS GENERATION (tied to Water Co cycles) ====
function generateNewsForAction(actionId){
    const pool = [
        {text: "P√©nurie d'eau signal√©e : hausse probable des actions Water Co", target:2, mult:1.20},
        {text: "Nouvelle r√®glementation favorable aux banques : l√©g√®re hausse Moni Invest", target:0, mult:1.08},
        {text: "Crash crypto mineur annonc√©", target:1, mult:0.80},
        {text: "Rumeur d'innovation sur Water Co : effet positif", target:2, mult:1.15},
        {text: "Crypto : annonce tech, volatilit√© accrue", target:1, mult:1.10}
    ];
    // pick news that targets the actionId preferably, otherwise random
    const candidates = pool.filter(p=>p.target === actionId);
    const pickPool = candidates.length? candidates : pool;
    const pick = pickPool[Math.floor(Math.random()*pickPool.length)];
    const news = { time: Date.now(), text: pick.text, target: pick.target, mult: pick.mult, note: "s'appliquera au prochain tick de l'action" };
    newsHistory.push(news);
    if(newsHistory.length>500) newsHistory.shift();
    // queue effect to apply on next change of the target action
    queuedNewsEffects[pick.target] = { mult: pick.mult, text: pick.text, queuedAt: Date.now() };
    localStorage.setItem("newsHistory", JSON.stringify(newsHistory));
    localStorage.setItem("queuedNewsEffects", JSON.stringify(queuedNewsEffects));
    return news;
}

// ==== BOT SIMULATION ====
function simulateBots() {
    bots.forEach(bot=>{
        if(Math.random() < 0.02){
            const actionId = Math.floor(Math.random()*actions.length);
            const a = actions[actionId];
            if(Math.random()<0.5){
                let amount = Math.round((Math.random()*140)+10);
                if(bot.cash - amount < 3000) {
                    amount = Math.max(0, Math.floor(bot.cash - 3000));
                }
                if(amount>0){
                    bot.portfolio[actionId] = (bot.portfolio[actionId]||0) + (amount / a.prix);
                    bot.cash -= amount;
                }
            } else {
                const parts = bot.portfolio[actionId] || 0;
                if(parts>0){
                    const pct = (Math.random()*0.6);
                    const sellParts = parts * pct;
                    bot.portfolio[actionId] = Math.max(0, parts - sellParts);
                    bot.cash += sellParts * a.prix;
                }
            }
        }
        const total = bot.cash + botPortfolioValue(bot);
        if(total < 3000){
            bot.cash += (3000 - total);
        }
    });
    saveBotsAndPlayers();
}

// ==== MARKET LOOP =====
// volatility and amplitude constraints
const volMap = {
    0: 0.02,  // Moni Invest stable ~2%
    1: 0.12,  // Crypto volatile ~12%
    2: 0.40   // Water Co very random ~40%
};

// amplitude constraints: [min,max] per action id for reference enforcement
const clampMap = {
    0: {min:50, max:150},    // Moni Invest ref 100 ¬±50
    1: {min:200, max:800},   // Crypto ref 500 ¬±300
    2: null                  // Water Co no clamp
};

setInterval(()=>{
    actions.forEach(a=>{
        a.timer--;
        if(a.timer<=0){
            a.prev = a.prix;

            // compute base change depending on action
            const baseVol = volMap[a.id] || 0.1;
            let newPrice;
            if(a.id === 0){
                // Moni Invest: small stable moves around 100
                const changeFactor = 1 + ((Math.random()*2-1) * baseVol) * (Math.random()*0.8 + 0.6);
                newPrice = Math.round(a.prix * changeFactor);
            } else if(a.id === 1){
                // Crypto: keep mean ~500 with larger amplitude
                let drift = 1 + ((500 - a.prix) / 5000); // slight pull to 500
                const change = 1 + ((Math.random()*2-1) * baseVol * (Math.random()*1.5 + 0.7));
                newPrice = Math.round(a.prix * change * drift);
            } else {
                // Water Co: very random
                const change = 1 + ((Math.random()*2-1) * baseVol * (Math.random()*2 + 0.5));
                newPrice = Math.max(1, Math.round(a.prix * change));
            }

            // If there is a queued news effect for this action (from previous waterco tick), apply it now
            if(queuedNewsEffects[a.id]){
                const eff = queuedNewsEffects[a.id];
                newPrice = Math.max(1, Math.round(newPrice * eff.mult));
                // consume queued effect after applying
                delete queuedNewsEffects[a.id];
                localStorage.setItem("queuedNewsEffects", JSON.stringify(queuedNewsEffects));
            }

            // apply clamps if defined
            const clamp = clampMap[a.id];
            if(clamp){
                newPrice = Math.max(clamp.min, Math.min(clamp.max, newPrice));
            }

            a.prix = Math.max(1, newPrice);
            a.history.push(a.prix);
            if(a.history.length>10000) a.history.shift();

            // If this is Water Co (id 2), generate a news now that will be applied to the next Water Co tick
            if(a.id === 2){
                generateNewsForAction(2);
            }

            // reset timer per action
            a.timer = nextTimer(a.id);
            save();
        }
    });

    // simulate bots occasionally
    simulateBots();

    // only refresh view if user not typing
    if(!isUserTyping()){
        if(currentPage === "invest") investPage();
        if(currentPage && currentPage.startsWith("action_")) openAction(currentActionId);
        if(currentPage === "dashboard") dashboard();
    }

    // periodic snapshot for charts
    argentHistory.push(parseFloat(argent));
    if(argentHistory.length>10000) argentHistory.shift();
    rankHistory.push( getRankNumeric(argent + totalPortfolioValue()) );
    if(rankHistory.length>10000) rankHistory.shift();
    localStorage.setItem("argentHistory", JSON.stringify(argentHistory));
    localStorage.setItem("rankHistory", JSON.stringify(rankHistory));
    localStorage.setItem("newsHistory", JSON.stringify(newsHistory));
    localStorage.setItem("bots", JSON.stringify(bots));
},1000);

// ==== START ====
updatePlayersList();
dashboard();

// ===== CASINO IMPLEMENTATION (Roulette + Blackjack) =====
// (identique aux versions pr√©c√©dentes, r√©sultats affich√©s sur la page casino)
// ... (le code du casino existant pr√©c√©demment reste inchang√© pour la bri√®vet√©)
function openCasino(){
    currentPage = "casino";
    document.getElementById("content").innerHTML = `
        <h1>üé≤ Casino</h1>
        <div class="casino-grid">
            <div class="casino-col card">
                <h3>Roulette</h3>
                <div>
                    <label>Mise (‚Ç¨): <input id="rouletteBet" class="small-input" type="number" value="10"></label>
                </div>
                <div style="margin-top:8px;">
                    <button onclick="playRoulette('red')">Parier Rouge</button>
                    <button onclick="playRoulette('black')">Parier Noir</button>
                    <button onclick="openRouletteNumberInput()">Parier N¬∞</button>
                </div>
                <div id="rouletteNumberInput" style="display:none;margin-top:8px;">
                    <label>N¬∞ (0-36): <input id="rouletteNumber" class="small-input" type="number" min="0" max="36"></label>
                    <button onclick="playRoulette('number')">Parier N¬∞</button>
                </div>
                <div id="rouletteResult" class="helper" style="margin-top:10px;"></div>
            </div>

            <div class="casino-col card">
                <h3>Blackjack</h3>
                <div>
                    <label>Mise (‚Ç¨): <input id="bjBet" class="small-input" type="number" value="20"></label>
                </div>
                <div style="margin-top:8px;">
                    <button onclick="startBlackjack()">D√©marrer</button>
                    <button onclick="hitBlackjack()" id="bjHit" style="display:none;">Hit</button>
                    <button onclick="standBlackjack()" id="bjStand" style="display:none;">Stand</button>
                </div>
                <div id="bjState" class="helper" style="margin-top:10px;"></div>
            </div>
        </div>
        <br>
        <button onclick="dashboard()">‚¨Ö Retour</button>
    `;
}
function openRouletteNumberInput(){ document.getElementById('rouletteNumberInput').style.display='block'; }
function playRoulette(mode){
    let bet = parseFloat(document.getElementById("rouletteBet").value);
    if(!bet || bet<=0) return alert("Montant invalide");
    if(bet>argent) return alert("Pas assez d'argent");
    let number = Math.floor(Math.random()*37); // 0..36
    const redNumbers = new Set([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36]);
    let resultText = `La bille tombe sur ${number} (${ redNumbers.has(number) ? 'rouge' : (number===0? 'vert' : 'noir') }). `;
    let win = 0;
    if(mode === 'red' || mode === 'black'){
        if(number===0){
            win = 0;
        } else {
            const isRed = redNumbers.has(number);
            if((mode==='red' && isRed) || (mode==='black' && !isRed)) win = bet * 2;
        }
    } else if(mode === 'number'){
        const pick = parseInt(document.getElementById("rouletteNumber").value);
        if(isNaN(pick) || pick<0 || pick>36) return alert("Num√©ro invalide");
        if(pick === number) win = bet * 36;
    }
    if(win>0){
        argent += (win - bet);
        resultText += `Vous gagnez ${ (win - bet).toFixed(2) } ‚Ç¨ (retour total ${win.toFixed(2)} ‚Ç¨).`;
    } else {
        argent -= bet;
        resultText += `Vous perdez ${bet.toFixed(2)} ‚Ç¨.`;
    }
    save();
    const el = document.getElementById("rouletteResult");
    if(el) el.innerText = resultText;
}

let bjGame = null;
function startBlackjack(){
    let bet = parseFloat(document.getElementById("bjBet").value);
    if(!bet || bet<=0) return alert("Montant invalide");
    if(bet>argent) return alert("Pas assez d'argent");
    bjGame = { bet: bet, deck: createDeck(), player: [], dealer: [], finished: false };
    bjGame.player.push(drawCard(bjGame.deck)); bjGame.player.push(drawCard(bjGame.deck));
    bjGame.dealer.push(drawCard(bjGame.deck)); bjGame.dealer.push(drawCard(bjGame.deck));
    document.getElementById("bjHit").style.display = 'inline-block';
    document.getElementById("bjStand").style.display = 'inline-block';
    updateBJState();
}
function createDeck(){ const vals = [2,3,4,5,6,7,8,9,10,10,10,10,11]; let deck=[]; for(let i=0;i<4;i++) for(let v of vals) deck.push(v); for(let i=deck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]];} return deck; }
function drawCard(deck){ if(deck.length===0) deck = createDeck(); return deck.pop(); }
function sumHand(hand){ let sum = hand.reduce((s,v)=>s+v,0); while(sum>21 && hand.includes(11)){ hand[hand.indexOf(11)] = 1; sum -= 10; } return sum; }
function updateBJState(){ const state = document.getElementById("bjState"); if(!bjGame) return; const pSum = sumHand(bjGame.player.slice()); state.innerHTML = `Vos cartes: ${bjGame.player.join(', ')} (total ${pSum})<br>Dealer: ${bjGame.dealer[0]}, ?`; if(pSum===21||pSum>21) finishBlackjack(); }
function hitBlackjack(){ if(!bjGame) return; bjGame.player.push(drawCard(bjGame.deck)); updateBJState(); if(sumHand(bjGame.player)>21) finishBlackjack(); }
function standBlackjack(){ if(!bjGame) return; let dSum = sumHand(bjGame.dealer.slice()); while(dSum<17){ bjGame.dealer.push(drawCard(bjGame.deck)); dSum = sumHand(bjGame.dealer.slice()); } finishBlackjack(); }
function finishBlackjack(){ document.getElementById("bjHit").style.display='none'; document.getElementById("bjStand").style.display='none'; if(!bjGame) return; const pSum = sumHand(bjGame.player.slice()); const dSum = sumHand(bjGame.dealer.slice()); let result=''; if(pSum>21){ result = `Vous avez ${pSum} (bust). Vous perdez ${bjGame.bet.toFixed(2)} ‚Ç¨`; argent -= bjGame.bet; } else if(dSum>21){ result = `Dealer ${dSum} (bust). Vous gagnez ${bjGame.bet.toFixed(2)} ‚Ç¨`; argent += bjGame.bet; } else if(pSum > dSum){ result = `Vous ${pSum} vs Dealer ${dSum}. Vous gagnez ${bjGame.bet.toFixed(2)} ‚Ç¨`; argent += bjGame.bet; } else if(pSum === dSum){ result = `√âgalit√© ${pSum}. Mise rembours√©e.`; } else { result = `Vous ${pSum} vs Dealer ${dSum}. Vous perdez ${bjGame.bet.toFixed(2)} ‚Ç¨`; argent -= bjGame.bet; } save(); const state = document.getElementById("bjState"); if(state) state.innerHTML += `<br><strong>${result}</strong>`; bjGame = null; }

// ==== FIN CASINO / FONCTIONS ====

</script>
</body>
</html>

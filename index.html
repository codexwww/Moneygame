<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Money Game</title>
<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #0f172a;
    color: white;
    display: flex;
}

.sidebar {
    width: 220px;
    background: #020617;
    height: 100vh;
    padding: 20px;
}

.menu-item {
    margin: 15px 0;
    cursor: pointer;
    color: #cbd5f5;
    font-weight: bold;
}
.menu-item:hover { color: #22c55e; }

.content {
    flex: 1;
    padding: 30px;
}

.card {
    background: #1e293b;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 15px;
    box-shadow: 0 0 10px rgba(0,255,0,0.2);
    transition: all 0.3s ease;
}

.card.up { box-shadow: 0 0 10px rgba(34,197,94,0.5); }
.card.down { box-shadow: 0 0 10px rgba(239,68,68,0.5); }

.action {
    display: flex;
    justify-content: space-between;
    cursor: pointer;
    padding: 10px;
}

.up { color: #22c55e; }
.down { color: #ef4444; }

canvas {
    background: #020617;
    border-radius: 10px;
    margin-top: 15px;
}

input {
    padding: 8px;
    width: 140px;
    margin-right: 10px;
}

button {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    background: #22c55e;
    color: black;
    margin-right: 5px;
    transition: all 0.2s ease;
}
button:hover { background: #16a34a; }

h1 { margin-top: 0; }

/* New styles for dashboard layout */
.row { display:flex; gap:15px; align-items:flex-start; }
.col { flex:1; }
.small { width:360px; }
.card-clickable { cursor:pointer; }
.kv { display:flex; align-items:center; justify-content:space-between; }
.meta { color:#cbd5f5; font-size:0.9em; }
.badge { background:#111827; padding:6px 10px; border-radius:8px; color:#cbd5f5; }
.quick-buttons button { padding:6px 10px; font-size:0.9em; margin-right:6px; }
.helper { color:#9ca3af; font-size:0.9em; margin-top:8px; }
</style>
</head>
<body>

<div class="sidebar">
    <h2>üí∞ Money Game</h2>
    <div class="menu-item" onclick="dashboard()">üè† Accueil</div>
    <div class="menu-item" onclick="investPage()">üìà Investir</div>
    <div class="menu-item" onclick="helpPage()">‚ùì Help</div>
</div>

<div class="content" id="content"></div>

<script>
// ===== VARIABLES GLOBALES =====
let currentPage = "dashboard"; // dashboard / invest / action_x / help
let currentActionId = null;

let argent = localStorage.getItem("argent")
    ? parseFloat(localStorage.getItem("argent"))
    : 10000;

let portfolio = localStorage.getItem("portfolio")
    ? JSON.parse(localStorage.getItem("portfolio"))
    : {0:0,1:0,2:0};

const actions = [
    loadAction(0,"Alpha Corp",100),
    loadAction(1,"Beta Industries",250),
    loadAction(2,"Gamma Tech",500)
];

// histories for charts
let argentHistory = localStorage.getItem("argentHistory")
    ? JSON.parse(localStorage.getItem("argentHistory"))
    : [argent];

let rankHistory = localStorage.getItem("rankHistory")
    ? JSON.parse(localStorage.getItem("rankHistory"))
    : [getRankNumeric(argent)];

// simple fake players list for the "classement" view (single-player for now)
const players = localStorage.getItem("players")
    ? JSON.parse(localStorage.getItem("players"))
    : [
        {name: "Vous", total: argent},
        {name: "Joueur2", total: 8000},
        {name: "Joueur3", total: 15000},
        {name: "Joueur4", total: 30000}
    ];

function loadAction(id, nom, prix) {
    let saved = localStorage.getItem("action_"+id);
    if (saved) return JSON.parse(saved);
    return { id, nom, prix, prev: prix, timer: rand(), history: [prix] };
}

function rand() { return Math.floor(Math.random()*5+1)*60; }

function save() {
    localStorage.setItem("argent", argent);
    localStorage.setItem("portfolio", JSON.stringify(portfolio));
    actions.forEach(a=>localStorage.setItem("action_"+a.id, JSON.stringify(a)));

    // record argent snapshot for charting (limit length)
    argentHistory.push(parseFloat(argent));
    if(argentHistory.length>2000) argentHistory.shift();
    localStorage.setItem("argentHistory", JSON.stringify(argentHistory));

    // record rank snapshot (numeric) for charting
    rankHistory.push(getRankNumeric(argent + totalPortfolioValue()));
    if(rankHistory.length>2000) rankHistory.shift();
    localStorage.setItem("rankHistory", JSON.stringify(rankHistory));

    // update players (keep "Vous" synced)
    let you = players.find(p=>p.name==="Vous");
    if(you) you.total = argent + totalPortfolioValue();
    localStorage.setItem("players", JSON.stringify(players));
}

// helper to calculate total portfolio value
function totalPortfolioValue() {
    let v = 0;
    actions.forEach(a=> v += portfolio[a.id]*a.prix);
    return v;
}

// numeric rank for charting (higher is better)
function getRankNumeric(total) {
    if(total<10000) return 1;
    else if(total<20000) return 2;
    else if(total<50000) return 3;
    else return 4;
}

// ==== CALCUL DU RANG (texte) ====
function getRank() {
    let total = argent + totalPortfolioValue();

    if(total<10000) return "D√©butant";
    else if(total<20000) return "Amateur";
    else if(total<50000) return "Pro";
    else return "Expert";
}

// ==== DASHBOARD AM√âLIOR√â ====
function dashboard() {
    currentPage = "dashboard";
    let value = totalPortfolioValue();

    let html = `<h1>Tableau de bord</h1>
        <div class="row">
            <div class="col small">
                <div class="card card-clickable" onclick="openMoney()"> 
                    <div class="kv">
                        <div>
                            <strong>üí∞ Argent disponible</strong><br>
                            <span class="meta">${argent.toFixed(2)} ‚Ç¨</span>
                        </div>
                        <div class="badge">${portfolioValueLabel()}</div>
                    </div>
                    <canvas id="moneyMiniChart" width="320" height="100"></canvas>
                    <div class="helper">Cliquez pour voir plus de d√©tails sur votre historique d'argent.</div>
                </div>

                <div class="card card-clickable" onclick="openStatus()">
                    <strong>üè∑Ô∏è Statut</strong><br>
                    <div style="margin-top:8px;">
                        <span style="font-size:1.1em; font-weight:bold;">${getRank()}</span>
                        <div class="helper">Cliquez pour voir les paliers de statut et seuils associ√©s.</div>
                    </div>
                </div>
            </div>

            <div class="col">
                <div class="card card-clickable" onclick="openRank()">
                    <strong>üèÖ Rang (global)</strong><br>
                    <div style="margin-top:8px;">
                        <span style="font-size:1.2em; font-weight:bold;">#1 (solo)</span>
                        <div class="helper">Cliquez pour afficher le classement des joueurs et l'√©volution du rang.</div>
                    </div>
                    <canvas id="rankMiniChart" width="600" height="120"></canvas>
                </div>

                <div class="card">
                    <strong>üíº Valeur du portefeuille</strong><br>
                    <span class="meta">${value.toFixed(2)} ‚Ç¨</span>
                    <div style="margin-top:10px;">
                        <strong>D√©tails :</strong><br>`;
    actions.forEach(a=>{
        html+=`${a.nom} : ${portfolio[a.id].toFixed(4)} parts (valeur : ${(portfolio[a.id]*a.prix).toFixed(2)} ‚Ç¨)<br>`;
    });
    html+=`</div></div>
            </div>
        </div>`;
    document.getElementById("content").innerHTML = html;

    // draw mini charts
    drawMiniMoneyChart();
    drawMiniRankChart();
}

function portfolioValueLabel() {
    let val = totalPortfolioValue();
    if(val<1000) return `${val.toFixed(0)} ‚Ç¨ portefeuille`;
    return `${val.toFixed(2)} ‚Ç¨ portefeuille`;
}

// ==== INVEST PAGE ====
function investPage() {
    currentPage = "invest";
    let html = `<h1>Investir</h1>`;
    actions.forEach(a=>{
        let diff = (((a.prix-a.prev)/a.prev)*100).toFixed(2);
        html += `<div class="card ${diff>=0?'up':'down'} action" onclick="openAction(${a.id})">
            <div>
                <strong>${a.nom}</strong><br>
                <span class="${diff>=0?'up':'down'}">${diff>=0?'‚ñ≤':'‚ñº'} ${diff} %</span>
            </div>
            <div>‚è±Ô∏è ${a.timer}s</div>
        </div>`;
    });
    document.getElementById("content").innerHTML = html;
}

// ==== ACTION DETAIL ====
function openAction(id) {
    currentPage = "action_"+id;
    currentActionId = id;
    let a = actions[id];
    let holdingsValue = (portfolio[id]*a.prix).toFixed(2);
    document.getElementById("content").innerHTML = `
        <h1>${a.nom}</h1>
        <canvas id="chart" width="700" height="250"></canvas>

        <div class="card">
            <button onclick="drawChart(${id},60)">1h</button>
            <button onclick="drawChart(${id},300)">1 jour</button>
            <button onclick="drawChart(${id},1000)">1 semaine</button>
        </div>

        <div class="card">
            üí≤ Prix : ${a.prix} ‚Ç¨<br>
            üì¶ Parts : ${portfolio[id].toFixed(4)} (valeur actuelle : ${holdingsValue} ‚Ç¨)
        </div>

        <div class="card">
            <strong>Acheter</strong><br>
            <input id="buyAmount" type="number" placeholder="Montant ‚Ç¨">
            <button onclick="buy(${id})">Investir</button>
            <div class="helper">Entrez un montant en euros √† convertir au prix courant.</div>
        </div>

        <div class="card">
            <strong>Vendre</strong><br>
            <div>
                <label><input type="radio" name="sellMode" value="euro" checked> Vendre en ‚Ç¨</label>
                <label style="margin-left:12px;"><input type="radio" name="sellMode" value="parts"> Vendre en parts</label>
            </div>
            <input id="sellAmount" type="number" placeholder="Montant ‚Ç¨ ou parts selon le mode">
            <div class="quick-buttons" style="margin-top:8px;">
                <button onclick="setSellPercent(${id},25)">Vendre 25%</button>
                <button onclick="setSellPercent(${id},50)">Vendre 50%</button>
                <button onclick="setSellPercent(${id},100)">Vendre tout</button>
            </div>
            <br>
            <button onclick="sell(${id})">Ex√©cuter vente</button>
            <button onclick="sellAll(${id})" style="background:#ef4444;color:white;">Vendre tout</button>
            <div class="helper">Vous pouvez vendre par montant en ‚Ç¨ (au prix courant) ou par parts. Un clic sur "Vendre tout" vend la totalit√© de vos parts pour le montant courant.</div>
        </div>

        <div class="card">üèÖ Rang : ${getRank()}</div>

        <button onclick="investPage()">‚¨Ö Retour</button>
    `;
    drawChart(id,60);
}

// ==== setSellPercent helper ====
function setSellPercent(id, percent) {
    let a = actions[id];
    let partsOwned = portfolio[id];
    let mode = document.querySelector('input[name="sellMode"]:checked').value;
    if(mode === 'parts') {
        document.getElementById('sellAmount').value = (partsOwned * (percent/100)).toFixed(6);
    } else {
        // euros value of that percent
        let euros = partsOwned * a.prix * (percent/100);
        document.getElementById('sellAmount').value = euros.toFixed(2);
    }
}

// ==== COURBE ====
function drawChart(id, points) {
    let a = actions[id];
    let data = a.history.slice(-points);
    let c = document.getElementById("chart");
    if(!c) return;
    let ctx = c.getContext("2d");
    ctx.clearRect(0,0,c.width,c.height);

    let max = Math.max(...data);
    let min = Math.min(...data);

    ctx.beginPath();
    ctx.strokeStyle = "#22c55e";
    ctx.lineWidth = 2;

    data.forEach((v,i)=>{
        let x = i*(c.width/data.length);
        let y = c.height - ((v-min)/(max-min||1))* (c.height-10) - 5;
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
    });
    ctx.stroke();
}

// mini money chart on dashboard
function drawMiniMoneyChart() {
    let c = document.getElementById("moneyMiniChart");
    if(!c) return;
    let ctx = c.getContext("2d");
    let data = argentHistory.slice(-60);
    ctx.clearRect(0,0,c.width,c.height);
    let max = Math.max(...data);
    let min = Math.min(...data);
    ctx.beginPath();
    ctx.strokeStyle = "#60a5fa";
    data.forEach((v,i)=>{
        let x = i*(c.width/data.length);
        let y = c.height - ((v-min)/(max-min||1))* (c.height-10) - 5;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
}

function drawMiniRankChart() {
    let c = document.getElementById("rankMiniChart");
    if(!c) return;
    let ctx = c.getContext("2d");
    let data = rankHistory.slice(-80);
    ctx.clearRect(0,0,c.width,c.height);
    let max = Math.max(...data);
    let min = Math.min(...data);
    ctx.beginPath();
    ctx.strokeStyle = "#fbbf24";
    data.forEach((v,i)=>{
        let x = i*(c.width/data.length);
        let y = c.height - ((v-min)/(max-min||1))* (c.height-10) - 5;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
}

// ==== BUY / SELL ====
function buy(id) {
    let amount = parseFloat(document.getElementById("buyAmount").value);
    let a = actions[id];
    if(!amount || amount<=0) return alert("Montant invalide");
    if(amount>argent) return alert("Montant sup√©rieur √† l'argent disponible");
    portfolio[id]+=amount/a.prix;
    argent-=amount;
    save();
    openAction(id);
}

// sell supports two modes: euros or parts
function sell(id) {
    let raw = parseFloat(document.getElementById("sellAmount").value);
    let a = actions[id];
    if(!raw || raw<=0) return alert("Montant invalide");
    let mode = document.querySelector('input[name="sellMode"]:checked').value;
    if(mode === 'parts') {
        if(raw>portfolio[id]) return alert("Vous n'avez pas autant de parts");
        portfolio[id]-=raw;
        let euros = raw * a.prix;
        argent+=euros;
    } else {
        // euro mode
        let parts = raw / a.prix;
        if(parts>portfolio[id]) return alert("Vous n'avez pas suffisamment de parts pour ce montant");
        portfolio[id]-=parts;
        argent+=raw;
    }
    save();
    openAction(id);
}

// sell all holdings of an action
function sellAll(id) {
    let a = actions[id];
    let parts = portfolio[id];
    if(parts<=0) return alert("Vous n'avez pas de parts √† vendre");
    let euros = parts * a.prix;
    portfolio[id]=0;
    argent+=euros;
    save();
    openAction(id);
}

// ==== HELP PAGE ====
function helpPage() {
    currentPage = "help";
    currentActionId = null;
    document.getElementById("content").innerHTML = `
        <h1>üìò Aide / Instructions</h1>
        <div class="card">
            <h3>Argent vs Portefeuille</h3>
            <p>
                üí∞ Argent : votre cash disponible pour investir.<br>
                üíº Portefeuille : parts d'actions poss√©d√©es. Valeur = parts √ó prix actuel.<br>
                Total compte = Argent + Portefeuille
            </p>
        </div>

        <div class="card">
            <h3>Investir / Vendre</h3>
            <p>
                1Ô∏è‚É£ Cliquez sur "Investir" pour voir les actions.<br>
                2Ô∏è‚É£ Cliquez sur une action pour voir sa courbe.<br>
                3Ô∏è‚É£ Entrez le montant √† investir ou r√©cup√©rer, puis cliquez sur le bouton.<br>
                ‚ö†Ô∏è Vous ne pouvez pas investir plus que votre argent disponible, ni r√©cup√©rer plus que vos parts.
            </p>
        </div>

        <div class="card">
            <h3>Courbes</h3>
            <p>
                üìà Les courbes montrent l'√©volution du prix. Utilisez les boutons 1h / 1 jour / 1 semaine.
            </p>
        </div>

        <div class="card">
            <h3>Rang</h3>
            <p>
                üèÖ Votre rang d√©pend de Argent + Portefeuille.<br>
                - D√©butant : < 10‚ÄØ000 ‚Ç¨<br>
                - Amateur : 10‚ÄØ000 ‚Äì 20‚ÄØ000 ‚Ç¨<br>
                - Pro : 20‚ÄØ000 ‚Äì 50‚ÄØ000 ‚Ç¨<br>
                - Expert : > 50‚ÄØ000 ‚Ç¨
            </p>
        </div>

        <div class="card">
            <h3>Astuce</h3>
            <p>
                Commencez petit, suivez les courbes, et n‚Äôinvestissez pas tout d‚Äôun coup !
            </p>
        </div>
    `;
}

// ==== DETAILED VIEWS FOR CARDS ====
// openMoney: affiche l'historique d√©taill√© de l'argent
function openMoney() {
    currentPage = "money";
    document.getElementById("content").innerHTML = `
        <h1>Historique de l'argent</h1>
        <div class="card">
            <strong>Argent disponible : ${argent.toFixed(2)} ‚Ç¨</strong>
            <canvas id="moneyChart" width="900" height="250"></canvas>
            <div class="helper">Historique enregistr√© √† chaque action et tick de march√© (dernier ${argentHistory.length} snapshots).</div>
        </div>
        <button onclick="dashboard()">‚¨Ö Retour</button>
    `;
    // draw after inserting DOM
    setTimeout(()=> {
        let c = document.getElementById("moneyChart");
        if(!c) return;
        let ctx = c.getContext("2d");
        let data = argentHistory.slice(-500);
        ctx.clearRect(0,0,c.width,c.height);
        let max = Math.max(...data);
        let min = Math.min(...data);
        ctx.beginPath();
        ctx.strokeStyle = "#60a5fa";
        ctx.lineWidth = 2;
        data.forEach((v,i)=>{
            let x = i*(c.width/data.length);
            let y = c.height - ((v-min)/(max-min||1))* (c.height-10) - 5;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
    },50);
}

// openRank: affiche classement des joueurs et evolution du rang
function openRank() {
    currentPage = "rank";
    // sort players by total desc
    let sorted = players.slice().sort((a,b)=>b.total - a.total);
    let html = `<h1>Classement des joueurs</h1>
        <div class="card">
            <strong>Classement</strong><br><ol>`;
    sorted.forEach(p=>{
        html+=`<li>${p.name} ‚Äî ${p.total.toFixed(2)} ‚Ç¨</li>`;
    });
    html+=`</ol>
            <canvas id="rankChart" width="900" height="200"></canvas>
            <div class="helper">Graphique d'√©volution du rang (√©chelle interne). Dans cette version solo, la liste est simul√©e.</div>
        </div>
        <button onclick="dashboard()">‚¨Ö Retour</button>`;
    document.getElementById("content").innerHTML = html;

    setTimeout(()=> {
        let c = document.getElementById("rankChart");
        if(!c) return;
        let ctx = c.getContext("2d");
        let data = rankHistory.slice(-500);
        ctx.clearRect(0,0,c.width,c.height);
        let max = Math.max(...data);
        let min = Math.min(...data);
        ctx.beginPath();
        ctx.strokeStyle = "#f59e0b";
        ctx.lineWidth = 2;
        data.forEach((v,i)=>{
            let x = i*(c.width/data.length);
            let y = c.height - ((v-min)/(max-min||1))* (c.height-10) - 5;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
    },50);
}

// openStatus: affiche paliers de statut
function openStatus() {
    currentPage = "status";
    document.getElementById("content").innerHTML = `
        <h1>Statuts et seuils</h1>
        <div class="card">
            <strong>Statuts disponibles</strong>
            <ul>
                <li>D√©butant : &lt; 10 000 ‚Ç¨</li>
                <li>Amateur : 10 000 ‚Ç¨ ‚Äì 20 000 ‚Ç¨</li>
                <li>Pro : 20 000 ‚Ç¨ ‚Äì 50 000 ‚Ç¨</li>
                <li>Expert : &gt; 50 000 ‚Ç¨</li>
            </ul>
            <div class="helper">Votre statut actuel : <strong>${getRank()}</strong></div>
        </div>
        <button onclick="dashboard()">‚¨Ö Retour</button>
    `;
}

// ==== MARKET LOOP =====
setInterval(()=>{
    actions.forEach(a=>{
        a.timer--;
        if(a.timer<=0){
            a.prev=a.prix;
            a.prix=Math.max(10,Math.floor(a.prix*(1+(Math.random()*0.2-0.1))));
            a.history.push(a.prix);
            if(a.history.length>2000) a.history.shift();
            a.timer=rand();
            save();
        }
    });

    // Seule la page action ouverte ou invest page est mise √† jour
    if(currentPage === "invest") investPage();
    if(currentPage && currentPage.startsWith("action_")) openAction(currentActionId);

    // periodic snapshot even if market didn't change to keep money/rank history flowing
    argentHistory.push(parseFloat(argent));
    if(argentHistory.length>2000) argentHistory.shift();
    rankHistory.push( getRankNumeric(argent + totalPortfolioValue()) );
    if(rankHistory.length>2000) rankHistory.shift();
    localStorage.setItem("argentHistory", JSON.stringify(argentHistory));
    localStorage.setItem("rankHistory", JSON.stringify(rankHistory));
    localStorage.setItem("players", JSON.stringify(players));

},1000);

// ==== START ====
dashboard();
</script>
</body>
</html>
